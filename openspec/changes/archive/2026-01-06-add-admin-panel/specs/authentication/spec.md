## ADDED Requirements

### Requirement: User Roles
Система SHALL поддерживать систему ролей пользователей (Role-Based Access Control).

#### Scenario: Роли пользователей
- **WHEN** пользователь создаётся в системе
- **THEN** ему назначается одна из ролей: DRIVER, DISPATCHER, ADMIN, PENDING
- **AND** роль по умолчанию для новых пользователей: PENDING

#### Scenario: Роль Водитель
- **WHEN** пользователь имеет роль DRIVER
- **THEN** он может создавать заказы только для себя
- **AND** он может обновлять свою локацию
- **AND** он может изменять статус своих заказов
- **AND** он не может управлять другими пользователями

#### Scenario: Роль Диспетчер
- **WHEN** пользователь имеет роль DISPATCHER
- **THEN** он может создавать заказы для любого водителя
- **AND** он может назначать водителей на заказы
- **AND** он может отменять любые заказы
- **AND** он может просматривать всех водителей и заказы

#### Scenario: Роль Администратор
- **WHEN** пользователь имеет роль ADMIN
- **THEN** он имеет все права роли DISPATCHER
- **AND** он может управлять ролями пользователей
- **AND** он может блокировать и разблокировать пользователей
- **AND** он получает уведомления о новых регистрациях

#### Scenario: Роль Ожидающий
- **WHEN** пользователь имеет роль PENDING
- **THEN** он не может выполнять действия в боте
- **AND** он не может создавать заказы
- **AND** он ожидает одобрения администратором
- **AND** после одобрения ему назначается роль DRIVER или DISPATCHER

### Requirement: User Activity Status
Система SHALL поддерживать флаг активности пользователей is_active.

#### Scenario: Активный пользователь
- **WHEN** пользователь имеет is_active=True
- **THEN** он может авторизовываться через API и бота
- **AND** все функции системы доступны для него

#### Scenario: Заблокированный пользователь
- **WHEN** пользователь имеет is_active=False
- **THEN** он не может авторизовываться через API
- **AND** AuthMiddleware отклоняет его запросы
- **AND** бот игнорирует его сообщения

#### Scenario: Автоматическая блокировка при создании
- **WHEN** новый пользователь создаётся через Telegram
- **THEN** is_active устанавливается в True для DRIVER и DISPATCHER ролей
- **AND** is_active устанавливается в False для PENDING роли

### Requirement: Role-Based Access Control in API
Система SHALL проверять права доступа на основе ролей для всех защищённых эндпоинтов.

#### Scenario: Создание заказа DISPATCHER
- **WHEN** пользователь с ролью DISPATCHER создаёт заказ
- **THEN** он может назначить любого водителя (driver_id в запросе)
- **AND** заказ создаётся успешно

#### Scenario: Создание заказа DRIVER
- **WHEN** пользователь с ролью DRIVER создаёт заказ
- **THEN** driver_id игнорируется
- **AND** заказ автоматически назначается на него самого

#### Scenario: Назначение водителя на заказ
- **WHEN** пользователь пытается назначить водителя на заказ
- **THEN** доступ разрешён для ролей ADMIN и DISPATCHER
- **AND** доступ запрещён для роли DRIVER

### Requirement: JWT Token Role Information
Система SHALL включать информацию о роли в JWT токен.

#### Scenario: Токен содержит роль
- **WHEN** создаётся JWT токен для пользователя
- **THEN** токен содержит поле role со значением UserRole (admin/dispatcher/driver)
- **AND** токен содержит поле driver_id
- **AND** API может извлекать роль из токена для проверки прав

#### Scenario: Извлечение роли из токена
- **WHEN** защищённый эндпоинт получает запрос с JWT токеном
- **THEN** role извлекается из токена
- **AND** используется для проверки прав доступа
