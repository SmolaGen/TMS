# authentication Specification

## Purpose
TBD - created by archiving change add-missing-specs. Update Purpose after archive.
## Requirements
### Requirement: Telegram WebApp Authentication
Система SHALL обеспечивать аутентификацию водителей через Telegram WebApp и Telegram Login Widget.

#### Scenario: Успешный вход через Telegram Mini App
- **WHEN** водитель открывает приложение в Telegram Mini App
- **THEN** система получает initData от Telegram WebApp
- **AND** валидирует initData используя HMAC-SHA256 с секретным ключом бота
- **AND** извлекается telegram_id пользователя
- **AND** возвращается JWT токен с информацией о водителе

#### Scenario: Успешный вход через Telegram Login Widget
- **WHEN** водитель открывает приложение в обычном браузере
- **THEN** отображается Telegram Login Widget
- **AND** при клике на виджет система получает данные пользователя
- **AND** валидирует данные используя SHA256(bot_token) для Login Widget формата
- **AND** извлекается telegram_id пользователя
- **AND** возвращается JWT токен с информацией о водителе

#### Scenario: Автоматическая регистрация нового водителя
- **WHEN** водитель впервые входит через Telegram (Mini App или Login Widget)
- **THEN** система автоматически создает запись водителя с данными из Telegram
- **AND** возвращается JWT токен для дальнейшей работы

#### Scenario: Использование сохраненного токена
- **WHEN** водитель повторно открывает приложение
- **THEN** система проверяет наличие сохраненного JWT токена в localStorage
- **AND** если токен валидный, авторизация пропускается без запроса к серверу
- **AND** если токена нет или он невалидный, запрашивается новая авторизация

#### Scenario: Невалидные данные Telegram
- **WHEN** отправляется запрос с подделанным или истекшим init_data
- **THEN** возвращается ошибка 401 Unauthorized

### Requirement: JWT Token Management
Система SHALL использовать JWT токены для защиты API эндпоинтов.

#### Scenario: Использование токена для доступа
- **WHEN** запрос к защищенному эндпоинту содержит валидный JWT токен в заголовке Authorization
- **THEN** токен валидируется и извлекается информация о водителе
- **AND** запрос обрабатывается с контекстом текущего водителя

#### Scenario: Невалидный или истекший токен
- **WHEN** запрос содержит невалидный или истекший токен
- **THEN** возвращается ошибка 401 Unauthorized

### Requirement: Protected Routes
Система SHALL требовать аутентификацию для большинства API эндпоинтов.

#### Scenario: Доступ к защищенным эндпоинтам
- **WHEN** запрос к `/api/v1/orders`, `/api/v1/drivers` или другим защищенным эндпоинтам не содержит токена
- **THEN** возвращается ошибка 401 Unauthorized

#### Scenario: Публичные эндпоинты
- **WHEN** запрос к `/api/v1/geocoding/search` или `/health`
- **THEN** аутентификация не требуется

### Requirement: User Roles
Система SHALL поддерживать систему ролей пользователей (Role-Based Access Control).

#### Scenario: Роли пользователей
- **WHEN** пользователь создаётся в системе
- **THEN** ему назначается одна из ролей: DRIVER, DISPATCHER, ADMIN, PENDING
- **AND** роль по умолчанию для новых пользователей: PENDING

#### Scenario: Роль Водитель
- **WHEN** пользователь имеет роль DRIVER
- **THEN** он может создавать заказы только для себя
- **AND** он может обновлять свою локацию
- **AND** он может изменять статус своих заказов
- **AND** он не может управлять другими пользователями

#### Scenario: Роль Диспетчер
- **WHEN** пользователь имеет роль DISPATCHER
- **THEN** он может создавать заказы для любого водителя
- **AND** он может назначать водителей на заказы
- **AND** он может отменять любые заказы
- **AND** он может просматривать всех водителей и заказы

#### Scenario: Роль Администратор
- **WHEN** пользователь имеет роль ADMIN
- **THEN** он имеет все права роли DISPATCHER
- **AND** он может управлять ролями пользователей
- **AND** он может блокировать и разблокировать пользователей
- **AND** он получает уведомления о новых регистрациях

#### Scenario: Роль Ожидающий
- **WHEN** пользователь имеет роль PENDING
- **THEN** он не может выполнять действия в боте
- **AND** он не может создавать заказы
- **AND** он ожидает одобрения администратором
- **AND** после одобрения ему назначается роль DRIVER или DISPATCHER

### Requirement: User Activity Status
Система SHALL поддерживать флаг активности пользователей is_active.

#### Scenario: Активный пользователь
- **WHEN** пользователь имеет is_active=True
- **THEN** он может авторизовываться через API и бота
- **AND** все функции системы доступны для него

#### Scenario: Заблокированный пользователь
- **WHEN** пользователь имеет is_active=False
- **THEN** он не может авторизовываться через API
- **AND** AuthMiddleware отклоняет его запросы
- **AND** бот игнорирует его сообщения

#### Scenario: Автоматическая блокировка при создании
- **WHEN** новый пользователь создаётся через Telegram
- **THEN** is_active устанавливается в True для DRIVER и DISPATCHER ролей
- **AND** is_active устанавливается в False для PENDING роли

### Requirement: Role-Based Access Control in API
Система SHALL проверять права доступа на основе ролей для всех защищённых эндпоинтов.

#### Scenario: Создание заказа DISPATCHER
- **WHEN** пользователь с ролью DISPATCHER создаёт заказ
- **THEN** он может назначить любого водителя (driver_id в запросе)
- **AND** заказ создаётся успешно

#### Scenario: Создание заказа DRIVER
- **WHEN** пользователь с ролью DRIVER создаёт заказ
- **THEN** driver_id игнорируется
- **AND** заказ автоматически назначается на него самого

#### Scenario: Назначение водителя на заказ
- **WHEN** пользователь пытается назначить водителя на заказ
- **THEN** доступ разрешён для ролей ADMIN и DISPATCHER
- **AND** доступ запрещён для роли DRIVER

### Requirement: JWT Token Role Information
Система SHALL включать информацию о роли в JWT токен.

#### Scenario: Токен содержит роль
- **WHEN** создаётся JWT токен для пользователя
- **THEN** токен содержит поле role со значением UserRole (admin/dispatcher/driver)
- **AND** токен содержит поле driver_id
- **AND** API может извлекать роль из токена для проверки прав

#### Scenario: Извлечение роли из токена
- **WHEN** защищённый эндпоинт получает запрос с JWT токеном
- **THEN** role извлекается из токена
- **AND** используется для проверки прав доступа

