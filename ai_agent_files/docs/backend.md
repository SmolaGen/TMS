# Бэкенд и API

Бэкенд написан на **Python** с использованием фреймворка **FastAPI**.

## Структура проекта (`src/`)

- `api/` - Роуты и зависимости FastAPI.
  - `routes.py` - Определение эндпоинтов (Orders, Drivers, Location).
  - `dependencies.py` - Внедрение зависимостей (DI).
- `bot/` - Исходный код Telegram бота (Aiogram).
- `core/` - Базовые утилиты (логирование, middleware, конфиг).
- `database/` - Работа с БД (SQLAlchemy, модели).
- `schemas/` - Schemas (Pydantic модели) для валидации данных.
- `services/` - Бизнес-логика.
  - `driver_service.py`: Управление водителями.
  - `order_service.py`: Управление заказами, проверка конфликтов времени.
  - `location_manager.py`: Работа с геопозицией (Redis).
- `workers/` - Фоновые воркеры (ingest worker для сохранения координат из Redis в Postgres).

## Ключевые технологии

- **FastAPI**: Высокопроизводительный веб-фреймворк.
- **SQLAlchemy (Async)**: ORM для работы с PostgreSQL.
- **PostGIS**: Расширение PostgreSQL для хранения и запросов гео-данных.
- **Redis**: Используется для хранения "живых" (live) координат водителей (высокая скорость записи) и кэширования.
- **Aiogram**: Асинхронный фреймворк для Telegram бота.

## API Эндпоинты

Основные группы эндпоинтов (`/api/v1`):

### Drivers (`/drivers`)
- `POST /` - Регистрация водителя.
- `GET /` - Список водителей.
- `GET /live` - Получение **текущих** координат активных водителей (из Redis).
- `PATCH /{id}` - Обновление профиля/статуса.
- `POST /{id}/location` - Отправка координат (High-throughput, пишет в Redis).

### Orders (`/orders`)
- `POST /` - Создание заказа. Проверяет **Exclusion Constraint** в БД для исключения пересечений по времени.
- `PATCH /{id}/move` - Перенос времени заказа (Drag-and-Drop).

## Гео-сервисы

Проект использует локальные инстансы гео-сервисов для независимости от внешних API:
1. **OSRM** (порт 5000): Построение маршрутов и расчет ETA.
2. **Photon** (порт 2322): Геокодинг (адрес -> координаты) и обратный геокодинг.
