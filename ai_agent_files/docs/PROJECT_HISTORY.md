# –ò—Å—Ç–æ—Ä–∏—è –ü—Ä–æ–µ–∫—Ç–∞ TMS ‚Äî –ü–æ–ª–Ω–∞—è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

> **Transportation Management System** ‚Äî —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º —Å real-time –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π

üìÖ **–ü–µ—Ä–∏–æ–¥ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** 26 –¥–µ–∫–∞–±—Ä—è 2025 ‚Äî 31 –¥–µ–∫–∞–±—Ä—è 2025  
üë§ **–ê–≤—Ç–æ—Ä:** SmolaGen (alsmolentsev98@gmail.com)  
üåê **–ü—Ä–æ–¥–∞–∫—à–µ–Ω –¥–æ–º–µ–Ω:** https://myappnf.ru  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 13 –∫–æ–º–º–∏—Ç–æ–≤, ~10,000+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, 4 –¥–Ω—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞](#–æ–±–∑–æ—Ä-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
4. [–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏](#—Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
   - [–î–µ–Ω—å 1: 26 –¥–µ–∫–∞–±—Ä—è 2025](#-–¥–µ–Ω—å-1-26-–¥–µ–∫–∞–±—Ä—è-2025)
   - [–î–µ–Ω—å 2: 27 –¥–µ–∫–∞–±—Ä—è 2025](#-–¥–µ–Ω—å-2-27-–¥–µ–∫–∞–±—Ä—è-2025)
   - [–î–µ–Ω—å 3: 28 –¥–µ–∫–∞–±—Ä—è 2025](#-–¥–µ–Ω—å-3-28-–¥–µ–∫–∞–±—Ä—è-2025)
   - [–î–µ–Ω—å 4: 31 –¥–µ–∫–∞–±—Ä—è 2025](#-–¥–µ–Ω—å-4-31-–¥–µ–∫–∞–±—Ä—è-2025)
5. [API Reference](#api-reference)
6. [–ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–ø–æ–¥—Ä–æ–±–Ω—ã–µ-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

---

## –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

TMS (Transportation Management System) ‚Äî —ç—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –¥–ª—è:

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è |
|---------|----------|------------|
| **Real-time –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ** | –ü–æ–ª—É—á–µ–Ω–∏–µ GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ Telegram Live Location | aiogram 3.x + Redis Streams |
| **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏** | CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ | FastAPI + PostgreSQL Exclusion Constraints |
| **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π Dashboard** | –ö–∞—Ä—Ç–∞ —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏ –∏ Drag-n-Drop —Ç–∞–π–º–ª–∞–π–Ω | React + Leaflet + vis-timeline |
| **High-Throughput Ingestion** | –ó–∞–ø–∏—Å—å 10-50k –ª–æ–∫–∞—Ü–∏–π/—Å–µ–∫ –≤ PostgreSQL | Redis Consumer Groups + COPY |

### –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞

1. **Exclusion Constraints** ‚Äî –æ–¥–∏–Ω –≤–æ–¥–∏—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–∫–∞–∑—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î)
2. **Live Location TTL** ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–æ–¥–∏—Ç–µ–ª—è —Å—á–∏—Ç–∞—é—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
3. **Rate Limiting** ‚Äî GPS endpoint –æ–≥—Ä–∞–Ω–∏—á–µ–Ω 30 –∑–∞–ø—Ä–æ—Å–∞–º–∏/–º–∏–Ω—É—Ç—É –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend Stack

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------------|--------|------------|
| **Framework** | FastAPI | ‚â•0.100 | Async REST API + WebSocket |
| **ORM** | SQLAlchemy | 2.x | Async ORM —Å declarative style |
| **Database** | PostgreSQL | 15+ | –û—Å–Ω–æ–≤–Ω–∞—è –ë–î |
| **GIS** | PostGIS | 3.x | –ì–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ |
| **Cache/Queue** | Redis | 7+ | Streams, Hash, Set |
| **Bot** | aiogram | 3.x | Telegram Bot Framework |
| **Security** | SlowAPI | 0.1.9 | Rate Limiting |
| **Logging** | structlog | ‚Äî | Structured JSON logging |
| **Migrations** | Alembic | ‚Äî | Database migrations |

### Frontend Stack

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------------|--------|------------|
| **Framework** | React | 18.x | UI Framework |
| **Language** | TypeScript | 5.x | Type safety |
| **Build** | Vite | 5.x | –°–±–æ—Ä–∫–∞ –∏ dev server |
| **State** | TanStack Query | 5.x | Data Fetching + Optimistic UI |
| **State** | Zustand | 4.x | WebSocket State Management |
| **Map** | Leaflet | 1.9 | –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ |
| **Timeline** | vis-timeline | 7.x | Drag-n-Drop —Ç–∞–π–º–ª–∞–π–Ω |
| **UI** | Ant Design | 5.x | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ |

### Infrastructure

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------------|------------|
| **Containers** | Docker Compose | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ |
| **Reverse Proxy** | Nginx | SSL termination, gzip |
| **SSL** | Let's Encrypt | –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ |
| **Process Manager** | PM2 | Production process —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ |
| **Routing** | OSRM | –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π) |
| **Geocoding** | Photon | –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤ |

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### High-Level Architecture

```mermaid
flowchart TB
    subgraph Clients
        TG[ü§ñ Telegram Bot]
        WEB[üñ•Ô∏è Web Dashboard]
    end
    
    subgraph LoadBalancer
        NGINX[Nginx\nSSL + Rate Limit]
    end
    
    subgraph Backend
        API[FastAPI\nREST + WebSocket]
        BOT[aiogram\nWebhook Handler]
        INGEST[Ingest Worker\nConsumer Group]
        SYNC[Sync Worker\nRedis ‚Üí PG]
    end
    
    subgraph DataLayer
        REDIS[(Redis 7\nStreams + Hash)]
        PG[(PostgreSQL 15\n+ PostGIS)]
    end
    
    subgraph ExternalServices
        OSRM[OSRM\nRouting]
        PHOTON[Photon\nGeocoding]
    end
    
    TG -->|Webhook| NGINX
    WEB -->|HTTPS/WSS| NGINX
    
    NGINX --> API
    NGINX --> BOT
    
    BOT -->|XADD| REDIS
    API -->|XADD| REDIS
    
    REDIS -->|XREADGROUP| INGEST
    INGEST -->|COPY| PG
    
    API --> PG
    API --> OSRM
    API --> PHOTON
```

### Data Flow: GPS Location

```mermaid
sequenceDiagram
    participant Driver as üì± Driver (Telegram)
    participant Bot as ü§ñ aiogram Bot
    participant Redis as üíæ Redis
    participant Worker as ‚öôÔ∏è Ingest Worker
    participant PG as üóÑÔ∏è PostgreSQL
    participant Dashboard as üñ•Ô∏è Dashboard

    Driver->>Bot: Live Location (edited_message)
    Bot->>Redis: XADD driver:locations
    Note over Redis: MAXLEN ~100k
    
    Redis-->>Dashboard: Hash: driver:loc:{id}
    Note over Dashboard: Real-time –∫–∞—Ä—Ç–∞
    
    Worker->>Redis: XREADGROUP (batch 2000)
    Worker->>PG: COPY driver_location_history
    Worker->>Redis: XACK
    
    Dashboard->>PG: GET /api/v1/drivers/{id}/history
```

### Clean Architecture Layers

```mermaid
graph TD
    subgraph Presentation
        REST[REST API\nroutes.py]
        WS[WebSocket\nmain.py]
        BOT_H[Bot Handlers\nhandlers/]
    end
    
    subgraph Application
        SVC[Services\ndriver_service.py\norder_service.py]
        LOC[LocationManager\nlocation_manager.py]
    end
    
    subgraph Domain
        MODELS[Models\nmodels.py]
        SCHEMAS[Schemas\nschemas/]
    end
    
    subgraph Infrastructure
        REPO[Repository\nrepository.py]
        UOW[Unit of Work\nuow.py]
        CONN[Connection\nconnection.py]
    end
    
    REST --> SVC
    WS --> SVC
    BOT_H --> LOC
    
    SVC --> UOW
    LOC --> REDIS[(Redis)]
    
    UOW --> REPO
    REPO --> CONN
    CONN --> PG[(PostgreSQL)]
```

---

## –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

---

### üìÖ –î–µ–Ω—å 1: 26 –¥–µ–∫–∞–±—Ä—è 2025

–í –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è backend –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞.

---

#### –ö–æ–º–º–∏—Ç 1: `996c6ec6c489794146b26fd389d64493bcf1706b`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `feat(tms): –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TMS –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã`  
üìÖ **–î–∞—Ç–∞:** 2025-12-26 06:54:47 +1000  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 19 —Ñ–∞–π–ª–æ–≤, +1632 —Å—Ç—Ä–æ–∫–∏

##### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –§–∞–π–ª—ã | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|-------|----------|
| **Configuration** | `.env.example`, `.gitignore` | –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è |
| **Docker** | `Dockerfile`, `docker-compose.yml` | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è |
| **Database** | `alembic/`, `src/database/` | –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ –º–æ–¥–µ–ª–∏ |
| **API** | `src/main.py`, `src/config.py` | FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ |
| **Tests** | `tests/` | pytest –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è |

##### Docker Compose Services

```yaml
# docker-compose.yml (–æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã)
services:
  postgres:
    image: postgis/postgis:15-3.3-alpine
    environment:
      POSTGRES_DB: tms
      POSTGRES_USER: tms
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"  # –ò–∑–º–µ–Ω—ë–Ω –ø–æ—Ä—Ç –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  osrm:
    image: ghcr.io/project-osrm/osrm-backend
    volumes:
      - ./osrm-data:/data
    command: osrm-routed --algorithm mld /data/primorsky-krai.osrm
    profiles: ["routing"]

  photon:
    image: komoot/photon:latest
    volumes:
      - ./photon-data:/photon/photon_data
    profiles: ["geocoding"]
```

##### –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (SQLAlchemy 2.0)

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `src/database/models.py`:**

```python
"""
TMS Database Models

–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç SQLAlchemy 2.0 —Å –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–º —Å—Ç–∏–ª–µ–º –∏ GeoAlchemy2.
"""

from datetime import datetime
from enum import Enum as PyEnum
from typing import Optional

from geoalchemy2 import Geometry
from sqlalchemy import (
    BigInteger,
    CheckConstraint,
    Enum,
    ForeignKey,
    Index,
    String,
    Text,
    text,
)
from sqlalchemy.dialects.postgresql import TSTZRANGE
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column, relationship


class Base(DeclarativeBase):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π."""
    pass


class DriverStatus(str, PyEnum):
    """–°—Ç–∞—Ç—É—Å—ã –≤–æ–¥–∏—Ç–µ–ª—è."""
    AVAILABLE = "available"      # –î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–æ–≤
    BUSY = "busy"                # –ó–∞–Ω—è—Ç (–≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–∫–∞–∑)
    OFFLINE = "offline"          # –ù–µ –Ω–∞ —Å–≤—è–∑–∏


class OrderStatus(str, PyEnum):
    """–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–∞."""
    PENDING = "pending"          # –û–∂–∏–¥–∞–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è
    ASSIGNED = "assigned"        # –ù–∞–∑–Ω–∞—á–µ–Ω –≤–æ–¥–∏—Ç–µ–ª—å
    IN_PROGRESS = "in_progress"  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
    COMPLETED = "completed"      # –ó–∞–≤–µ—Ä—à—ë–Ω
    CANCELLED = "cancelled"      # –û—Ç–º–µ–Ω—ë–Ω


class OrderPriority(str, PyEnum):
    """–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–∫–∞–∑–∞."""
    LOW = "low"
    NORMAL = "normal"
    HIGH = "high"
    URGENT = "urgent"


class Driver(Base):
    """
    –ú–æ–¥–µ–ª—å –≤–æ–¥–∏—Ç–µ–ª—è.
    
    Attributes:
        id: –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
        telegram_id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ Telegram
        name: –ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è
        phone: –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        status: –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –≤–æ–¥–∏—Ç–µ–ª—è
        created_at: –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
        updated_at: –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        is_active: –§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –≤—Ö–æ–¥ –≤ –±–æ—Ç)
    """
    __tablename__ = "drivers"
    
    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    telegram_id: Mapped[int] = mapped_column(
        BigInteger, 
        unique=True, 
        index=True,
        comment="Telegram user ID"
    )
    name: Mapped[str] = mapped_column(
        String(255),
        comment="–ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è"
    )
    phone: Mapped[Optional[str]] = mapped_column(
        String(20),
        nullable=True,
        comment="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
    )
    status: Mapped[DriverStatus] = mapped_column(
        Enum(DriverStatus, name="driver_status", 
             values_callable=lambda x: [e.value for e in x]),
        default=DriverStatus.OFFLINE,
        server_default=text("'offline'"),
        comment="–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å"
    )
    created_at: Mapped[datetime] = mapped_column(
        default=datetime.utcnow,
        server_default=text("CURRENT_TIMESTAMP")
    )
    updated_at: Mapped[datetime] = mapped_column(
        default=datetime.utcnow,
        server_default=text("CURRENT_TIMESTAMP"),
        onupdate=datetime.utcnow
    )
    is_active: Mapped[bool] = mapped_column(
        default=True,
        server_default=text("true"),
        comment="–§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –≤—Ö–æ–¥ –≤ –±–æ—Ç)"
    )
    
    # Relationships
    orders: Mapped[list["Order"]] = relationship(
        "Order",
        back_populates="driver",
        lazy="selectin"
    )
    
    def __repr__(self) -> str:
        return f"<Driver(id={self.id}, name='{self.name}', status={self.status.value})>"


class Order(Base):
    """
    –ú–æ–¥–µ–ª—å –∑–∞–∫–∞–∑–∞.
    
    Note:
        Exclusion Constraint `no_driver_time_overlap` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç,
        —á—Ç–æ –æ–¥–∏–Ω –≤–æ–¥–∏—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–∫–∞–∑—ã.
    """
    __tablename__ = "orders"
    
    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    driver_id: Mapped[Optional[int]] = mapped_column(
        ForeignKey("drivers.id", ondelete="SET NULL"),
        nullable=True,
        index=True,
        comment="FK –Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è"
    )
    status: Mapped[OrderStatus] = mapped_column(
        Enum(OrderStatus, name="order_status",
             values_callable=lambda x: [e.value for e in x]),
        default=OrderStatus.PENDING,
        server_default=text("'pending'"),
        comment="–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞"
    )
    priority: Mapped[OrderPriority] = mapped_column(
        Enum(OrderPriority, name="order_priority",
             values_callable=lambda x: [e.value for e in x]),
        default=OrderPriority.NORMAL,
        server_default=text("'normal'"),
        comment="–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–∫–∞–∑–∞"
    )
    
    pickup_location: Mapped[Optional[str]] = mapped_column(
        Geometry(geometry_type="POINT", srid=4326),
        nullable=True,
        comment="–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ –ø–æ–≥—Ä—É–∑–∫–∏ (WGS84)"
    )
    dropoff_location: Mapped[Optional[str]] = mapped_column(
        Geometry(geometry_type="POINT", srid=4326),
        nullable=True,
        comment="–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ –≤—ã–≥—Ä—É–∑–∫–∏ (WGS84)"
    )
    
    comment: Mapped[Optional[str]] = mapped_column(
        Text,
        nullable=True,
        comment="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É"
    )
    
    created_at: Mapped[datetime] = mapped_column(
        default=datetime.utcnow,
        server_default=text("CURRENT_TIMESTAMP")
    )
    updated_at: Mapped[datetime] = mapped_column(
        default=datetime.utcnow,
        server_default=text("CURRENT_TIMESTAMP"),
        onupdate=datetime.utcnow
    )
    
    # Relationships
    driver: Mapped[Optional["Driver"]] = relationship(
        "Driver",
        back_populates="orders",
        lazy="joined"
    )
    
    __table_args__ = (
        Index("ix_orders_status_priority", "status", "priority"),
    )


class DriverLocationHistory(Base):
    """
    –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –≤–æ–¥–∏—Ç–µ–ª—è.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤—ã–º –≤–æ—Ä–∫–µ—Ä–æ–º –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∏–∑ Redis.
    """
    __tablename__ = "driver_location_history"
    
    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    driver_id: Mapped[int] = mapped_column(
        ForeignKey("drivers.id", ondelete="CASCADE"),
        index=True,
        comment="ID –≤–æ–¥–∏—Ç–µ–ª—è"
    )
    location: Mapped[str] = mapped_column(
        Geometry(geometry_type="POINT", srid=4326),
        comment="–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (WGS84)"
    )
    recorded_at: Mapped[datetime] = mapped_column(
        index=True,
        comment="–í—Ä–µ–º—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–º"
    )
    created_at: Mapped[datetime] = mapped_column(
        default=datetime.utcnow,
        server_default=text("CURRENT_TIMESTAMP"),
        comment="–í—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ –≤ –ë–î"
    )
    
    driver: Mapped["Driver"] = relationship("Driver", backref="location_history")
    
    __table_args__ = (
        Index("ix_driver_location_time", "driver_id", "recorded_at"),
    )
```

##### Alembic Migration: Exclusion Constraint

```python
# alembic/versions/001_initial.py

def upgrade():
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
    op.execute("CREATE EXTENSION IF NOT EXISTS btree_gist")
    op.execute("CREATE EXTENSION IF NOT EXISTS postgis")
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü...
    
    # Exclusion Constraint –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
    op.execute("""
        ALTER TABLE orders 
        ADD CONSTRAINT no_driver_time_overlap 
        EXCLUDE USING GIST (
            driver_id WITH =,
            time_range WITH &&
        )
        WHERE (status NOT IN ('completed', 'cancelled'))
    """)
```

##### Unit-—Ç–µ—Å—Ç—ã: Order Overlap

```python
# tests/test_order_overlap.py

import pytest
from sqlalchemy.exc import IntegrityError

@pytest.mark.asyncio
async def test_overlapping_orders_raises_integrity_error(session, driver):
    """–ü–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è –∑–∞–∫–∞–∑—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è –¥–æ–ª–∂–Ω—ã –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É."""
    order1 = Order(
        driver_id=driver.id,
        time_range="[2025-12-26 10:00, 2025-12-26 12:00)",
        status=OrderStatus.ASSIGNED
    )
    session.add(order1)
    await session.commit()
    
    order2 = Order(
        driver_id=driver.id,
        time_range="[2025-12-26 11:00, 2025-12-26 13:00)",  # –ü–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è!
        status=OrderStatus.ASSIGNED
    )
    session.add(order2)
    
    with pytest.raises(IntegrityError) as exc:
        await session.commit()
    
    assert "no_driver_time_overlap" in str(exc.value)


@pytest.mark.asyncio
async def test_adjacent_orders_allowed(session, driver):
    """–°–º–µ–∂–Ω—ã–µ –∑–∞–∫–∞–∑—ã (–±–µ–∑ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è) —Ä–∞–∑—Ä–µ—à–µ–Ω—ã."""
    order1 = Order(
        driver_id=driver.id,
        time_range="[2025-12-26 10:00, 2025-12-26 12:00)",
        status=OrderStatus.ASSIGNED
    )
    order2 = Order(
        driver_id=driver.id,
        time_range="[2025-12-26 12:00, 2025-12-26 14:00)",  # –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ
        status=OrderStatus.ASSIGNED
    )
    
    session.add_all([order1, order2])
    await session.commit()  # –î–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –±–µ–∑ –æ—à–∏–±–æ–∫
    
    assert order1.id is not None
    assert order2.id is not None


@pytest.mark.asyncio
async def test_different_drivers_overlapping_allowed(session, driver1, driver2):
    """–ü–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è –∑–∞–∫–∞–∑—ã –¥–ª—è –†–ê–ó–ù–´–• –≤–æ–¥–∏—Ç–µ–ª–µ–π —Ä–∞–∑—Ä–µ—à–µ–Ω—ã."""
    order1 = Order(
        driver_id=driver1.id,
        time_range="[2025-12-26 10:00, 2025-12-26 12:00)",
        status=OrderStatus.ASSIGNED
    )
    order2 = Order(
        driver_id=driver2.id,  # –î—Ä—É–≥–æ–π –≤–æ–¥–∏—Ç–µ–ª—å
        time_range="[2025-12-26 10:00, 2025-12-26 12:00)",  # –¢–æ –∂–µ –≤—Ä–µ–º—è
        status=OrderStatus.ASSIGNED
    )
    
    session.add_all([order1, order2])
    await session.commit()  # OK


@pytest.mark.asyncio
async def test_completed_order_allows_overlap(session, driver):
    """–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –∑–∞–∫–∞–∑ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –≤ —Ç–æ –∂–µ –≤—Ä–µ–º—è."""
    order1 = Order(
        driver_id=driver.id,
        time_range="[2025-12-26 10:00, 2025-12-26 12:00)",
        status=OrderStatus.COMPLETED  # –ó–∞–≤–µ—Ä—à—ë–Ω!
    )
    order2 = Order(
        driver_id=driver.id,
        time_range="[2025-12-26 10:00, 2025-12-26 12:00)",
        status=OrderStatus.ASSIGNED
    )
    
    session.add_all([order1, order2])
    await session.commit()  # OK, constraint –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç completed
```

---

#### –ö–æ–º–º–∏—Ç 2: `4778937e9b492b7ee721c6164211f655eace991a`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `feat: implement Repository, UoW and Service Layer for Driver management`  
üìÖ **–î–∞—Ç–∞:** 2025-12-26 07:30:32 +1000  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 8 —Ñ–∞–π–ª–æ–≤, +288 —Å—Ç—Ä–æ–∫

##### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ç—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞ Clean Architecture:

1. **Repository Pattern** ‚Äî –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
2. **Unit of Work** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
3. **Service Layer** ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

##### Repository Pattern

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `src/database/repository.py`:**

```python
from abc import ABC, abstractmethod
from typing import Generic, TypeVar, Type, Sequence, Optional
from sqlalchemy import select, update, delete
from sqlalchemy.ext.asyncio import AsyncSession
from src.database.models import Base

T = TypeVar("T", bound=Base)


class AbstractRepository(ABC, Generic[T]):
    """–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –±–∞–∑–æ–≤—ã–º–∏ CRUD –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏."""
    
    @abstractmethod
    def add(self, entity: T) -> T:
        raise NotImplementedError

    @abstractmethod
    async def get(self, id: int) -> Optional[T]:
        raise NotImplementedError

    @abstractmethod
    async def get_all(self) -> Sequence[T]:
        raise NotImplementedError
    
    @abstractmethod
    async def get_by_attribute(self, attr_name: str, value: any) -> Optional[T]:
        raise NotImplementedError

    @abstractmethod
    async def delete(self, id: int) -> bool:
        raise NotImplementedError


class SQLAlchemyRepository(AbstractRepository[T]):
    """–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –¥–ª—è SQLAlchemy."""
    
    def __init__(self, session: AsyncSession, model: Type[T]):
        self.session = session
        self.model = model

    def add(self, entity: T) -> T:
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Å—É—â–Ω–æ—Å—Ç—å –≤ —Å–µ—Å—Å–∏—é (–Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç)."""
        self.session.add(entity)
        return entity

    async def get(self, id: int) -> Optional[T]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å—É—â–Ω–æ—Å—Ç—å –ø–æ ID."""
        query = select(self.model).filter_by(id=id)
        result = await self.session.execute(query)
        return result.scalar_one_or_none()

    async def get_all(self) -> Sequence[T]:
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏."""
        query = select(self.model)
        result = await self.session.execute(query)
        return result.scalars().all()

    async def get_by_attribute(self, attr_name: str, value: any) -> Optional[T]:
        """–ü–æ–∏—Å–∫ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º—É –∞—Ç—Ä–∏–±—É—Ç—É."""
        query = select(self.model).filter(getattr(self.model, attr_name) == value)
        result = await self.session.execute(query)
        return result.scalar_one_or_none()

    async def delete(self, id: int) -> bool:
        """–£–¥–∞–ª—è–µ—Ç —Å—É—â–Ω–æ—Å—Ç—å –ø–æ ID."""
        query = delete(self.model).where(self.model.id == id)
        result = await self.session.execute(query)
        return result.rowcount > 0
```

##### Unit of Work Pattern

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `src/database/uow.py`:**

```python
from abc import ABC, abstractmethod
from sqlalchemy.ext.asyncio import AsyncSession
from src.database.connection import async_session_factory
from src.database.repository import SQLAlchemyRepository
from src.database.models import Driver, Order


class AbstractUnitOfWork(ABC):
    """–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π Unit of Work –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏."""
    drivers: SQLAlchemyRepository[Driver]
    orders: SQLAlchemyRepository[Order]

    async def __aenter__(self):
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        await self.rollback()

    @abstractmethod
    async def commit(self):
        raise NotImplementedError

    @abstractmethod
    async def rollback(self):
        raise NotImplementedError


class SQLAlchemyUnitOfWork(AbstractUnitOfWork):
    """
    –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è UoW –¥–ª—è SQLAlchemy.
    
    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
        async with SQLAlchemyUnitOfWork() as uow:
            driver = await uow.drivers.get(1)
            driver.name = "New Name"
            await uow.commit()  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –±–µ–∑ –æ—à–∏–±–æ–∫
    """
    
    def __init__(self, session_factory=async_session_factory):
        self.session_factory = session_factory

    async def __aenter__(self):
        self.session: AsyncSession = self.session_factory()
        self.drivers = SQLAlchemyRepository(self.session, Driver)
        self.orders = SQLAlchemyRepository(self.session, Order)
        return await super().__aenter__()

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if exc_type:
            await self.rollback()
        else:
            await self.commit()
        await self.session.close()

    async def commit(self):
        await self.session.commit()

    async def rollback(self):
        await self.session.rollback()
```

##### Service Layer

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `src/services/driver_service.py`:**

```python
from typing import List, Optional
from src.database.uow import AbstractUnitOfWork
from src.database.models import Driver, DriverStatus
from src.schemas.driver import DriverCreate, DriverResponse, DriverUpdate


class DriverService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è–º–∏.
    
    –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞.
    """
    
    def __init__(self, uow: AbstractUnitOfWork):
        self.uow = uow

    async def register_driver(self, data: DriverCreate) -> DriverResponse:
        """
        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è.
        
        Raises:
            ValueError: –ï—Å–ª–∏ telegram_id —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        """
        async with self.uow:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ telegram_id
            existing = await self.uow.drivers.get_by_attribute(
                "telegram_id", data.telegram_id
            )
            if existing:
                raise ValueError(
                    f"Driver with telegram_id {data.telegram_id} already exists"
                )

            driver = Driver(
                telegram_id=data.telegram_id,
                name=data.name,
                phone=data.phone,
                status=DriverStatus.OFFLINE,
                is_active=data.is_active
            )
            self.uow.drivers.add(driver)
            await self.uow.commit()
            return DriverResponse.model_validate(driver)

    async def get_driver(self, driver_id: int) -> Optional[DriverResponse]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è –ø–æ ID."""
        async with self.uow:
            driver = await self.uow.drivers.get(driver_id)
            return DriverResponse.model_validate(driver) if driver else None

    async def get_all_drivers(self) -> List[DriverResponse]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π."""
        async with self.uow:
            drivers = await self.uow.drivers.get_all()
            return [DriverResponse.model_validate(d) for d in drivers]

    async def update_driver(
        self, driver_id: int, data: DriverUpdate
    ) -> Optional[DriverResponse]:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª—è."""
        async with self.uow:
            driver = await self.uow.drivers.get(driver_id)
            if not driver:
                return None
            
            update_data = data.model_dump(exclude_unset=True)
            for key, value in update_data.items():
                setattr(driver, key, value)
            
            await self.uow.commit()
            return DriverResponse.model_validate(driver)
```

##### Pydantic Schemas

```python
# src/schemas/driver.py
from pydantic import BaseModel, ConfigDict
from typing import Optional
from datetime import datetime


class DriverCreate(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è."""
    telegram_id: int
    name: str
    phone: Optional[str] = None
    is_active: bool = True


class DriverUpdate(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è (–≤—Å–µ –ø–æ–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã)."""
    name: Optional[str] = None
    phone: Optional[str] = None
    status: Optional[str] = None
    is_active: Optional[bool] = None


class DriverResponse(BaseModel):
    """–°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤–æ–¥–∏—Ç–µ–ª—è."""
    model_config = ConfigDict(from_attributes=True)
    
    id: int
    telegram_id: int
    name: str
    phone: Optional[str]
    status: str
    is_active: bool
    created_at: datetime
    updated_at: datetime
```

---

#### –ö–æ–º–º–∏—Ç 3: `73d30f58605500fecde07fb6897001a279c45d45`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `feat(tms): implement API layer and real-time location processing (Step 3)`  
üìÖ **–î–∞—Ç–∞:** 2025-12-26 07:40:41 +1000  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 11 —Ñ–∞–π–ª–æ–≤, +715 —Å—Ç—Ä–æ–∫

##### REST API Endpoints

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ | Rate Limit |
|-------|----------|----------|------------|
| `POST` | `/api/v1/orders` | –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ | ‚Äî |
| `PATCH` | `/api/v1/orders/{id}/move` | –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑ | ‚Äî |
| `GET` | `/api/v1/drivers/live` | –ê–∫—Ç–∏–≤–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏ | ‚Äî |
| `POST` | `/api/v1/drivers/{id}/location` | –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é | 30/min |

##### API Routes Implementation

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `src/api/routes.py`:**

```python
from fastapi import APIRouter, Depends, HTTPException, Request, status
from sqlalchemy.exc import IntegrityError
from typing import List

from src.schemas.order import OrderCreate, OrderResponse, OrderMoveRequest, LocationUpdate
from src.schemas.driver import DriverCreate, DriverResponse, DriverUpdate
from src.services.order_service import OrderService
from src.services.driver_service import DriverService
from src.services.location_manager import LocationManager, DriverLocation
from src.api.dependencies import get_order_service, get_location_manager, get_driver_service
from src.core.logging import get_logger
from src.config import settings

from slowapi import Limiter
from slowapi.util import get_remote_address

logger = get_logger(__name__)
router = APIRouter(prefix="/v1", tags=["TMS API"])

limiter = Limiter(key_func=get_remote_address, storage_uri=settings.REDIS_URL)


@router.post("/orders", response_model=OrderResponse, status_code=status.HTTP_201_CREATED)
async def create_order(
    data: OrderCreate,
    service: OrderService = Depends(get_order_service)
):
    """
    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑. 
    
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î 
    (Exclusion Constraint). –ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 409.
    """
    try:
        return await service.create_order(data)
    except IntegrityError as e:
        # 23P01 - –ö–æ–¥ –æ—à–∏–±–∫–∏ PostgreSQL –¥–ª—è Exclusion Constraint
        if hasattr(e.orig, 'pgcode') and e.orig.pgcode == '23P01':
            logger.warning("order_overlap_detected", driver_id=data.driver_id)
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail={"error": "time_overlap", "message": "Driver is busy at this time"}
            )
        raise


@router.patch("/orders/{order_id}/move", response_model=OrderResponse)
async def move_order(
    order_id: int,
    data: OrderMoveRequest,
    service: OrderService = Depends(get_order_service)
):
    """
    –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–∫–∞–∑–∞.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è Drag-and-Drop –≤ Timeline UI.
    –ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 409.
    """
    try:
        result = await service.move_order(order_id, data)
        if not result:
            raise HTTPException(status_code=404, detail="Order not found")
        return result
    except IntegrityError as e:
        if hasattr(e.orig, 'pgcode') and e.orig.pgcode == '23P01':
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail={"error": "time_overlap", "message": "Driver is busy at this time"}
            )
        raise


@router.get("/drivers/live", response_model=List[DriverLocation])
async def get_live_drivers(
    manager: LocationManager = Depends(get_location_manager)
):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π.
    
    –î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ Redis Hash (real-time, TTL 5 –º–∏–Ω).
    """
    return await manager.get_active_drivers()


@router.post("/drivers/{driver_id}/location", status_code=status.HTTP_204_NO_CONTENT)
@limiter.limit(settings.RATE_LIMIT_LOCATION)
async def update_location(
    request: Request,  # Required by SlowAPI
    driver_id: int,
    data: LocationUpdate,
    manager: LocationManager = Depends(get_location_manager)
):
    """
    –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–æ–¥–∏—Ç–µ–ª—è.
    
    - –ü–∏—à–µ—Ç –≤ Redis Hash (–¥–ª—è real-time –∫–∞—Ä—Ç—ã)
    - –ü–∏—à–µ—Ç –≤ Redis Stream (–¥–ª—è PostgreSQL ingestion)
    - Rate Limit: 30 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
    """
    await manager.update_driver_location(
        driver_id=driver_id,
        latitude=data.latitude,
        longitude=data.longitude,
        status=data.status or "available",
        timestamp=data.timestamp
    )
    return None


# --- Driver CRUD ---

@router.post("/drivers", response_model=DriverResponse, status_code=status.HTTP_201_CREATED)
async def register_driver(
    data: DriverCreate,
    service: DriverService = Depends(get_driver_service)
):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è."""
    try:
        return await service.register_driver(data)
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))


@router.get("/drivers", response_model=List[DriverResponse])
async def list_drivers(
    service: DriverService = Depends(get_driver_service)
):
    """–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π."""
    return await service.get_all_drivers()


@router.get("/drivers/{driver_id}", response_model=DriverResponse)
async def get_driver(
    driver_id: int,
    service: DriverService = Depends(get_driver_service)
):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–¥–∏—Ç–µ–ª–µ."""
    driver = await service.get_driver(driver_id)
    if not driver:
        raise HTTPException(status_code=404, detail="Driver not found")
    return driver


@router.patch("/drivers/{driver_id}", response_model=DriverResponse)
async def update_driver(
    driver_id: int,
    data: DriverUpdate,
    service: DriverService = Depends(get_driver_service)
):
    """–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª—è."""
    driver = await service.update_driver(driver_id, data)
    if not driver:
        raise HTTPException(status_code=404, detail="Driver not found")
    return driver
```

##### LocationManager: Redis Integration

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `src/services/location_manager.py`:**

```python
import json
from datetime import datetime, timezone
from typing import List, Optional
from redis.asyncio import Redis

from pydantic import BaseModel, Field
from src.core.logging import get_logger

logger = get_logger(__name__)


class DriverLocation(BaseModel):
    """–°—Ö–µ–º–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è."""
    driver_id: int
    latitude: float
    longitude: float
    status: str = "available"
    timestamp: datetime


class LocationManager:
    """
    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π –≤–æ–¥–∏—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ Redis.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç:
    - Redis Hash –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (real-time –∫–∞—Ä—Ç–∞)
    - –ï–¥–∏–Ω—ã–π Redis Stream –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ (High-Throughput Ingestion)
    
    –ö–ª—é—á–∏ Redis:
    - driver:loc:{driver_id} ‚Äî Hash —Å —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–µ–π
    - drivers:active ‚Äî Set —Å ID –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π
    - driver:locations ‚Äî Stream –¥–ª—è ingestion –≤ PostgreSQL
    """

    KEY_PREFIX = "driver:loc"
    SET_ACTIVE = "drivers:active"
    STREAM_NAME = "driver:locations"
    STREAM_MAXLEN = 100000  # –ó–∞—â–∏—Ç–∞ RAM (~100K –∑–∞–ø–∏—Å–µ–π)
    TTL = 300  # 5 –º–∏–Ω—É—Ç

    def __init__(self, redis: Redis):
        self.redis = redis

    async def update_driver_location(
        self,
        driver_id: int,
        latitude: float,
        longitude: float,
        status: str = "available",
        timestamp: Optional[datetime] = None
    ) -> None:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ Redis.
        
        –¢—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏:
        1. Hash —Å TTL 5 –º–∏–Ω ‚Äî –¥–ª—è real-time –∫–∞—Ä—Ç—ã –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
        2. Set –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π ‚Äî –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
        3. Stream —Å MAXLEN ‚Äî –¥–ª—è PostgreSQL ingestion
        """
        ts = timestamp or datetime.now(timezone.utc)
        ts_iso = ts.isoformat()

        hash_data = {
            "lat": latitude,
            "lon": longitude,
            "status": status,
            "ts": ts_iso
        }

        # 1. –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è (Hash) ‚Äî –¥–ª—è –∫–∞—Ä—Ç—ã
        key = f"{self.KEY_PREFIX}:{driver_id}"
        await self.redis.hset(key, mapping=hash_data)
        await self.redis.expire(key, self.TTL)

        # 2. –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π
        await self.redis.sadd(self.SET_ACTIVE, driver_id)

        # 3. Stream –¥–ª—è –≤–æ—Ä–∫–µ—Ä–∞ —Å MAXLEN (approximate –¥–ª—è O(1))
        stream_data = {
            "driver_id": str(driver_id),
            "lat": str(latitude),
            "lon": str(longitude),
            "ts": ts_iso
        }
        await self.redis.xadd(
            self.STREAM_NAME,
            stream_data,
            maxlen=self.STREAM_MAXLEN,
            approximate=True
        )

        logger.debug(
            "location_updated",
            driver_id=driver_id,
            lat=latitude,
            lon=longitude
        )

    async def get_active_drivers(self) -> List[DriverLocation]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏.
        
        –î–ª—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä—Å–∫–æ–π –∫–∞—Ä—Ç—ã. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö.
        """
        active_ids = await self.redis.smembers(self.SET_ACTIVE)
        if not active_ids:
            return []

        results = []
        for d_id in active_ids:
            d_id = int(d_id)
            key = f"{self.KEY_PREFIX}:{d_id}"
            data = await self.redis.hgetall(key)
            
            if not data:
                # TTL –≤—ã—à–µ–ª ‚Äî —É–¥–∞–ª—è–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö
                await self.redis.srem(self.SET_ACTIVE, d_id)
                continue

            results.append(DriverLocation(
                driver_id=d_id,
                latitude=float(data[b"lat"]),
                longitude=float(data[b"lon"]),
                status=data.get(b"status", b"available").decode(),
                timestamp=datetime.fromisoformat(data[b"ts"].decode())
            ))
        
        return results

    async def get_driver_location(self, driver_id: int) -> Optional[DriverLocation]:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è."""
        key = f"{self.KEY_PREFIX}:{driver_id}"
        data = await self.redis.hgetall(key)
        
        if not data:
            return None

        return DriverLocation(
            driver_id=driver_id,
            latitude=float(data[b"lat"]),
            longitude=float(data[b"lon"]),
            status=data.get(b"status", b"available").decode(),
            timestamp=datetime.fromisoformat(data[b"ts"].decode())
        )
```

---

#### –ö–æ–º–º–∏—Ç 4: `5b39e1d01f5a6950ce1c7f647418e3375b46d612`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `TMS Step 3: API Layer & Real-time Location Processing`  
üìÖ **–î–∞—Ç–∞:** 2025-12-26 08:03:36 +1000  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 7 —Ñ–∞–π–ª–æ–≤, +94 —Å—Ç—Ä–æ–∫–∏

##### –ú–∏–≥—Ä–∞—Ü–∏—è: DriverLocationHistory —Å PostGIS

```python
# alembic/versions/002_add_location_history.py

def upgrade():
    op.create_table(
        'driver_location_history',
        sa.Column('id', sa.Integer(), primary_key=True, autoincrement=True),
        sa.Column('driver_id', sa.Integer(), 
                  sa.ForeignKey('drivers.id', ondelete='CASCADE'),
                  nullable=False, index=True),
        sa.Column('location', Geometry('POINT', srid=4326), nullable=False),
        sa.Column('recorded_at', sa.DateTime(timezone=True), nullable=False, index=True),
        sa.Column('created_at', sa.DateTime(timezone=True), 
                  server_default=sa.text('CURRENT_TIMESTAMP'))
    )
    
    # –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—é –∏ –≤—Ä–µ–º–µ–Ω–∏
    op.create_index(
        'ix_driver_location_time',
        'driver_location_history',
        ['driver_id', 'recorded_at']
    )


def downgrade():
    op.drop_table('driver_location_history')
```

##### Docker: ARM64 Support

```yaml
# docker-compose.yml –∏–∑–º–µ–Ω–µ–Ω–∏—è
postgres:
  image: postgis/postgis:15-3.3-alpine
  platform: linux/arm64  # –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Apple Silicon
  ports:
    - "5433:5432"  # –ò–∑–º–µ–Ω—ë–Ω –ø–æ—Ä—Ç –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
```

---

### üìÖ –î–µ–Ω—å 2: 27 –¥–µ–∫–∞–±—Ä—è 2025

–í—Ç–æ—Ä–æ–π –¥–µ–Ω—å –±—ã–ª –ø–æ—Å–≤—è—â—ë–Ω Telegram Bot –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ React Dashboard.

---

#### –ö–æ–º–º–∏—Ç 5: `618fa69e7d5a73a7b29680c6cf551f0dd9d7a720`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `feat: implement driver telegram bot integration`  
üìÖ **–î–∞—Ç–∞:** 2025-12-27 08:08:40 +1000  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 10 —Ñ–∞–π–ª–æ–≤, +384 —Å—Ç—Ä–æ–∫–∏

##### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Telegram Bot

```
src/bot/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ main.py                    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ Dispatcher
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ location.py           # –û–±—Ä–∞–±–æ—Ç–∫–∞ Live Location
‚îÇ   ‚îî‚îÄ‚îÄ orders.py             # –ö–æ–º–∞–Ω–¥–∞ /orders —Å WebApp
‚îî‚îÄ‚îÄ middlewares/
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ auth.py               # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è
    ‚îî‚îÄ‚îÄ idempotency.py        # –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
```

##### Location Handler

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `src/bot/handlers/location.py`:**

```python
from aiogram import Router, F
from aiogram.types import Message
from aiogram.enums import ContentType
from redis.asyncio import Redis
from datetime import datetime, timezone

from src.services.location_manager import LocationManager
from src.config import settings
from src.core.logging import get_logger

logger = get_logger(__name__)
router = Router(name="location")


async def get_location_manager() -> LocationManager:
    """–§–∞–±—Ä–∏–∫–∞ –¥–ª—è LocationManager."""
    redis = Redis.from_url(settings.REDIS_URL, decode_responses=False)
    return LocationManager(redis)


async def process_location(message: Message, driver_id: int) -> None:
    """
    –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –¥–ª—è message, —Ç–∞–∫ –∏ –¥–ª—è edited_message.
    Live Location –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ edited_message.
    """
    location = message.location
    if location is None:
        return
    
    manager = await get_location_manager()
    
    # edit_date –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Live Location, date –¥–ª—è –æ–±—ã—á–Ω—ã—Ö
    ts = message.edit_date or message.date or datetime.now(timezone.utc)
    
    await manager.update_driver_location(
        driver_id=driver_id,
        latitude=location.latitude,
        longitude=location.longitude,
        timestamp=ts
    )
    
    logger.info(
        "location_received",
        driver_id=driver_id,
        lat=location.latitude,
        lon=location.longitude,
        is_live=location.live_period is not None
    )


@router.message(F.content_type == ContentType.LOCATION)
async def on_location_message(message: Message, driver_id: int) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π.
    
    –ú–æ–∂–µ—Ç –±—ã—Ç—å:
    - –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—á–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è
    - –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ Live Location
    """
    await process_location(message, driver_id)
    
    if message.location and message.location.live_period:
        await message.reply(
            "üìç Live Location –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n"
            f"–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è: {message.location.live_period // 60} –º–∏–Ω."
        )
    else:
        await message.reply("üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞!")


@router.edited_message(F.content_type == ContentType.LOCATION)
async def on_location_edited(message: Message, driver_id: int) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Live Location.
    
    Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ ~1-4 —Å–µ–∫—É–Ω–¥—ã
    —á–µ—Ä–µ–∑ edited_message (–Ω–µ message!).
    """
    await process_location(message, driver_id)
    
    # live_period == 0 –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫—É —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏
    if message.location and message.location.live_period == 0:
        logger.info("live_location_stopped", driver_id=driver_id)
```

##### Auth Middleware

```python
# src/bot/middlewares/auth.py

from aiogram import BaseMiddleware
from aiogram.types import Message
from typing import Callable, Dict, Any, Awaitable

from src.database.uow import SQLAlchemyUnitOfWork
from src.core.logging import get_logger

logger = get_logger(__name__)


class AuthMiddleware(BaseMiddleware):
    """
    Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è.
    
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å —Å –¥–∞–Ω–Ω—ã–º telegram_id –≤ –ë–î.
    –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É.
    –ï—Å–ª–∏ –¥–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç driver –∏ driver_id –≤ data –¥–ª—è handlers.
    """
    
    async def __call__(
        self,
        handler: Callable[[Message, Dict[str, Any]], Awaitable[Any]],
        event: Message,
        data: Dict[str, Any]
    ) -> Any:
        telegram_id = event.from_user.id
        
        async with SQLAlchemyUnitOfWork() as uow:
            driver = await uow.drivers.get_by_attribute(
                "telegram_id", telegram_id
            )
            
            if not driver:
                await event.answer(
                    "‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.\n"
                    "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."
                )
                return None
            
            if not driver.is_active:
                await event.answer(
                    "‚ö†Ô∏è –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.\n"
                    "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É."
                )
                return None
            
            # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª—è –¥–ª—è handlers
            data["driver"] = driver
            data["driver_id"] = driver.id
        
        return await handler(event, data)
```

##### Idempotency Middleware

```python
# src/bot/middlewares/idempotency.py

from aiogram import BaseMiddleware
from aiogram.types import Message
from typing import Callable, Dict, Any, Awaitable
from redis.asyncio import Redis

from src.config import settings
from src.core.logging import get_logger

logger = get_logger(__name__)


class IdempotencyMiddleware(BaseMiddleware):
    """
    Middleware –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö message_id.
    TTL = 5 –º–∏–Ω—É—Ç –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏.
    """
    
    KEY_PREFIX = "tg:msg:"
    TTL = 300  # 5 –º–∏–Ω—É—Ç
    
    def __init__(self):
        self.redis: Redis | None = None
    
    async def _get_redis(self) -> Redis:
        if self.redis is None:
            self.redis = Redis.from_url(settings.REDIS_URL)
        return self.redis
    
    async def __call__(
        self,
        handler: Callable[[Message, Dict[str, Any]], Awaitable[Any]],
        event: Message,
        data: Dict[str, Any]
    ) -> Any:
        redis = await self._get_redis()
        key = f"{self.KEY_PREFIX}{event.message_id}"
        
        # SETNX: SET if Not eXists
        is_new = await redis.setnx(key, "1")
        if not is_new:
            logger.debug("duplicate_message", message_id=event.message_id)
            return None
        
        await redis.expire(key, self.TTL)
        return await handler(event, data)
```

##### Bot Initialization

```python
# src/bot/main.py

from aiogram import Bot, Dispatcher
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode

from src.config import settings
from src.bot.handlers.location import router as location_router
from src.bot.handlers.orders import router as orders_router
from src.bot.middlewares.auth import AuthMiddleware
from src.bot.middlewares.idempotency import IdempotencyMiddleware


async def create_bot() -> tuple[Bot, Dispatcher]:
    """–°–æ–∑–¥–∞—ë—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –±–æ—Ç–∞."""
    bot = Bot(
        token=settings.TELEGRAM_BOT_TOKEN,
        default=DefaultBotProperties(parse_mode=ParseMode.HTML)
    )
    
    dp = Dispatcher()
    
    # Middlewares (–ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!)
    dp.message.middleware(IdempotencyMiddleware())
    dp.message.middleware(AuthMiddleware())
    dp.edited_message.middleware(AuthMiddleware())  # –î–ª—è Live Location!
    
    # Handlers
    dp.include_router(location_router)
    dp.include_router(orders_router)
    
    return bot, dp


async def setup_webhook(bot: Bot) -> None:
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç webhook –¥–ª—è production."""
    await bot.set_webhook(
        url=settings.TELEGRAM_WEBHOOK_URL,
        allowed_updates=["message", "edited_message", "callback_query"]
    )
```

##### FastAPI Webhook Integration

```python
# src/main.py (–¥–æ–±–∞–≤–ª–µ–Ω–æ)

from aiogram.types import Update

@app.post("/bot/webhook")
async def bot_webhook(update: dict):
    """–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram."""
    bot = app.state.bot
    dp = app.state.dp
    
    telegram_update = Update.model_validate(update, context={"bot": bot})
    await dp.feed_update(bot, telegram_update)
    return {"ok": True}
```

---

#### –ö–æ–º–º–∏—Ç 6: `7971efeca19dfe2c5a8c85da2b9de5231f9b4c39`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `feat(frontend): –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Dashboard TMS —Å LiveMap –∏ TimelineView`  
üìÖ **–î–∞—Ç–∞:** 2025-12-27 16:20:16 +1000  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 26 —Ñ–∞–π–ª–æ–≤, +4432 —Å—Ç—Ä–æ–∫–∏

##### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Frontend

```
frontend/
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îî‚îÄ‚îÄ vite.svg
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts          # Axios instance
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ drivers.ts         # GET /drivers/live
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ orders.ts          # CRUD –∑–∞–∫–∞–∑–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboard/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Dashboard.tsx  # –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ LiveMap.tsx    # Leaflet –∫–∞—Ä—Ç–∞
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ DriverMarkers.tsx  # –ò–º–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ TimelineView.tsx   # vis-timeline
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useOrders.ts           # TanStack Query + Optimistic UI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDriverLocations.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useWebSocketSync.ts    # WS ‚Üí Query sync
‚îÇ   ‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useWebSocketStore.ts   # Zustand WebSocket
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api.ts             # TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx
‚îÇ   ‚îî‚îÄ‚îÄ main.tsx
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ vite.config.ts
‚îî‚îÄ‚îÄ tsconfig.json
```

##### Zustand WebSocket Store

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `frontend/src/stores/useWebSocketStore.ts`:**

```typescript
import { create } from 'zustand';

interface WebSocketState {
    socket: WebSocket | null;
    isConnected: boolean;
    reconnectAttempts: number;
    connect: () => void;
    disconnect: () => void;
    addMessageHandler: (handler: (event: MessageEvent) => void) => void;
    removeMessageHandler: (handler: (event: MessageEvent) => void) => void;
}

const MAX_RECONNECT_ATTEMPTS = 10;
const BASE_DELAY_MS = 1000;

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–Ω–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è re-renders
const messageHandlers = new Set<(event: MessageEvent) => void>();

export const useWebSocketStore = create<WebSocketState>((set, get) => ({
    socket: null,
    isConnected: false,
    reconnectAttempts: 0,

    connect: () => {
        const wsUrl = import.meta.env.VITE_WS_URL || 'ws://localhost:8000/ws';
        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log('[WS] Connected');
            set({ socket: ws, isConnected: true, reconnectAttempts: 0 });
        };

        ws.onmessage = (event) => {
            // –í—ã–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            messageHandlers.forEach((handler) => handler(event));
        };

        ws.onclose = () => {
            set({ isConnected: false });

            const { reconnectAttempts } = get();
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 1s, 2s, 4s, 8s...
                const delay = BASE_DELAY_MS * Math.pow(2, reconnectAttempts);
                console.log(`[WS] Reconnecting in ${delay}ms (attempt ${reconnectAttempts + 1})`);

                setTimeout(() => {
                    set({ reconnectAttempts: reconnectAttempts + 1 });
                    get().connect();
                }, delay);
            } else {
                console.error('[WS] Max reconnect attempts reached');
            }
        };

        ws.onerror = (error) => {
            console.error('[WS] Error:', error);
        };

        set({ socket: ws });
    },

    disconnect: () => {
        const { socket } = get();
        if (socket) {
            socket.close();
            set({ socket: null, isConnected: false, reconnectAttempts: 0 });
        }
    },

    addMessageHandler: (handler) => {
        messageHandlers.add(handler);
    },

    removeMessageHandler: (handler) => {
        messageHandlers.delete(handler);
    },
}));
```

##### TanStack Query: Optimistic UI

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `frontend/src/hooks/useOrders.ts`:**

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { notification } from 'antd';
import { useRef, useCallback } from 'react';
import { fetchOrders, moveOrder } from '../api/orders';
import type { OrderResponse, TimelineOrder, OrderMoveRequest } from '../types/api';

// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ API –æ—Ç–≤–µ—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç Timeline
const toTimelineOrder = (order: OrderResponse): TimelineOrder | null => {
    if (!order.time_start || !order.time_end) return null;

    return {
        id: String(order.id),
        group: order.driver_id ? String(order.driver_id) : 'unassigned',
        content: `–ó–∞–∫–∞–∑ #${order.id}`,
        start: new Date(order.time_start),
        end: new Date(order.time_end),
        className: `order-${order.priority}`,
        editable: order.status !== 'completed' && order.status !== 'cancelled',
    };
};

export const useOrders = (dateRange?: [Date, Date]) => {
    return useQuery({
        queryKey: ['orders', dateRange?.map(d => d.toISOString())],
        queryFn: () => fetchOrders(dateRange),
        select: (data) => data.map(toTimelineOrder).filter(Boolean) as TimelineOrder[],
        staleTime: 30_000,
        refetchInterval: 60_000,
    });
};

// –ú—É—Ç–∞—Ü–∏—è —Å Optimistic UI –∏ Rollback
export const useMoveOrder = () => {
    const queryClient = useQueryClient();
    const pendingCallbackRef = useRef<((item: any | null) => void) | null>(null);

    const mutation = useMutation({
        mutationFn: async ({ orderId, payload }: { orderId: number; payload: OrderMoveRequest }) => {
            return moveOrder(orderId, payload);
        },

        // Optimistic Update
        onMutate: async ({ orderId, payload }) => {
            await queryClient.cancelQueries({ queryKey: ['orders'] });
            const previousOrders = queryClient.getQueryData<OrderResponse[]>(['orders']);

            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
            queryClient.setQueryData<OrderResponse[]>(['orders'], (old) =>
                old?.map((order) =>
                    order.id === orderId
                        ? { ...order, time_start: payload.new_time_start, time_end: payload.new_time_end }
                        : order
                ) ?? []
            );

            return { previousOrders };
        },

        // –û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
        onError: (error: unknown, _variables, context) => {
            if (context?.previousOrders) {
                queryClient.setQueryData(['orders'], context.previousOrders);
            }

            // –û—Ç–∫–∞—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è –≤ Timeline
            if (pendingCallbackRef.current) {
                pendingCallbackRef.current(null);
                pendingCallbackRef.current = null;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ 409 Conflict
            const axiosError = error as { response?: { status?: number }; message?: string };
            if (axiosError.response?.status === 409) {
                notification.error({
                    message: '–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è',
                    description: '–í–æ–¥–∏—Ç–µ–ª—å —É–∂–µ –∑–∞–Ω—è—Ç –≤ —ç—Ç–æ –≤—Ä–µ–º—è. –ó–∞–∫–∞–∑ –≤–æ–∑–≤—Ä–∞—â—ë–Ω.',
                    duration: 5,
                });
            } else {
                notification.error({
                    message: '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è',
                    description: axiosError.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑',
                });
            }
        },

        // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        onSettled: () => {
            queryClient.invalidateQueries({ queryKey: ['orders'] });
            pendingCallbackRef.current = null;
        },
    });

    // –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è vis-timeline onMove
    const handleMove = useCallback(
        (item: any, callback: (item: any | null) => void) => {
            pendingCallbackRef.current = callback;
            callback(item);  // Optimistic UI

            mutation.mutate({
                orderId: Number(item.id),
                payload: {
                    new_time_start: item.start.toISOString(),
                    new_time_end: item.end?.toISOString() || item.start.toISOString(),
                },
            });
        },
        [mutation]
    );

    return { ...mutation, handleMove };
};
```

##### Dashboard Component

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `frontend/src/components/dashboard/Dashboard.tsx`:**

```tsx
import React, { useState } from 'react';
import { Layout, Badge, Button, message, Card, Space } from 'antd';
import { PlusOutlined, CarOutlined, ReloadOutlined } from '@ant-design/icons';
import { LiveMap } from './LiveMap';
import { TimelineView } from './TimelineView';
import { useWebSocketSync } from '../../hooks/useWebSocketSync';
import type { TimelineDriver, TimelineOrder } from '../../types/api';

const { Content } = Layout;

// –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫ - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫
const VLADIVOSTOK_LOCATIONS = [
    { name: '–ñ–î –í–æ–∫–∑–∞–ª', lat: 43.1155, lng: 131.8855 },
    { name: '–ü–æ–∫—Ä–æ–≤—Å–∫–∏–π –ø–∞—Ä–∫', lat: 43.1134, lng: 131.8903 },
    { name: '–ó–æ–ª–æ—Ç–æ–π –º–æ—Å—Ç', lat: 43.1067, lng: 131.8954 },
    { name: '–î–í–§–£', lat: 43.0227, lng: 131.8957 },
    { name: '–ê—ç—Ä–æ–ø–æ—Ä—Ç', lat: 43.3961, lng: 132.1481 },
    { name: '–§–æ–∫–∏–Ω–æ', lat: 42.9627, lng: 132.4011 },
    { name: '–ê—Ä—Ç—ë–º', lat: 43.3536, lng: 132.1886 },
    { name: '–£—Å—Å—É—Ä–∏–π—Å–∫', lat: 43.8029, lng: 131.9452 },
];

const mockDrivers: TimelineDriver[] = [
    { id: '1', content: '–ò–≤–∞–Ω–æ–≤ –ò.–ò.' },
    { id: '2', content: '–ü–µ—Ç—Ä–æ–≤ –ü.–ü.' },
    { id: '3', content: '–°–∏–¥–æ—Ä–æ–≤ –°.–°.' },
    { id: 'unassigned', content: '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω' },
];

export const Dashboard: React.FC = () => {
    const { isConnected } = useWebSocketSync();
    const [selectedOrderId, setSelectedOrderId] = useState<string | null>(null);
    const [orders, setOrders] = useState<TimelineOrder[]>([]);
    const [orderCounter, setOrderCounter] = useState(1);
    const [isCreating, setIsCreating] = useState(false);

    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–º–æ-–∑–∞–∫–∞–∑–∞
    const createDemoOrder = async () => {
        setIsCreating(true);

        const from = VLADIVOSTOK_LOCATIONS[Math.floor(Math.random() * VLADIVOSTOK_LOCATIONS.length)];
        let to = VLADIVOSTOK_LOCATIONS[Math.floor(Math.random() * VLADIVOSTOK_LOCATIONS.length)];
        while (to.name === from.name) {
            to = VLADIVOSTOK_LOCATIONS[Math.floor(Math.random() * VLADIVOSTOK_LOCATIONS.length)];
        }

        const driverId = String(Math.floor(Math.random() * 3) + 1);
        const now = new Date();
        const startOffset = Math.floor(Math.random() * 60);
        const duration = 30 + Math.floor(Math.random() * 90);

        const start = new Date(now.getTime() + startOffset * 60000);
        const end = new Date(start.getTime() + duration * 60000);

        const newOrder: TimelineOrder = {
            id: `order-${orderCounter}`,
            group: driverId,
            content: `#${orderCounter}: ${from.name} ‚Üí ${to.name}`,
            start: start,
            end: end,
            className: ['order-pending', 'order-high', 'order-normal'][Math.floor(Math.random() * 3)],
        };

        setOrders(prev => [...prev, newOrder]);
        setOrderCounter(prev => prev + 1);
        message.success(`–ó–∞–∫–∞–∑ #${orderCounter} —Å–æ–∑–¥–∞–Ω: ${from.name} ‚Üí ${to.name}`);
        setIsCreating(false);
    };

    return (
        <Layout style={{ height: '100vh', background: '#f5f5f5' }}>
            {/* –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */}
            <div style={{
                position: 'fixed',
                top: 16,
                left: 16,
                zIndex: 1000,
                background: 'white',
                padding: '8px 16px',
                borderRadius: 8,
                boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
            }}>
                <Badge
                    status={isConnected ? 'success' : 'processing'}
                    text={isConnected ? 'Online' : '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'}
                />
            </div>

            {/* –î–µ–º–æ-–ø–∞–Ω–µ–ª—å */}
            <Card
                size="small"
                style={{
                    position: 'fixed',
                    top: 16,
                    right: 16,
                    zIndex: 1000,
                    width: 280,
                    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                }}
                title={<span style={{ fontSize: 14 }}>üöó TMS Demo ‚Äî –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫</span>}
            >
                <Space direction="vertical" style={{ width: '100%' }} size="small">
                    <Button
                        type="primary"
                        icon={<PlusOutlined />}
                        onClick={createDemoOrder}
                        loading={isCreating}
                        block
                    >
                        –ù–æ–≤—ã–π –∑–∞–∫–∞–∑
                    </Button>
                    <div style={{
                        marginTop: 8,
                        padding: 8,
                        background: '#f5f5f5',
                        borderRadius: 4,
                        fontSize: 12,
                        color: '#666'
                    }}>
                        <strong>–ó–∞–∫–∞–∑–æ–≤:</strong> {orders.length}<br />
                        <strong>–í–æ–¥–∏—Ç–µ–ª–µ–π:</strong> 3 –∞–∫—Ç–∏–≤–Ω—ã—Ö
                    </div>
                </Space>
            </Card>

            <Content style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
                {/* –ö–∞—Ä—Ç–∞ - 60% –≤—ã—Å–æ—Ç—ã */}
                <div style={{ flex: '0 0 60%', position: 'relative' }}>
                    <LiveMap onDriverSelect={(id) => console.log('Selected driver:', id)} />
                </div>

                {/* –¢–∞–π–º–ª–∞–π–Ω - 40% –≤—ã—Å–æ—Ç—ã */}
                <div style={{
                    flex: '0 0 40%',
                    borderTop: '2px solid #e8e8e8',
                    overflow: 'hidden',
                }}>
                    <TimelineView
                        drivers={mockDrivers}
                        orders={orders}
                        onOrderSelect={setSelectedOrderId}
                    />
                </div>
            </Content>
        </Layout>
    );
};
```

---

#### –ö–æ–º–º–∏—Ç 7: `8935d9dc2f1653ddc103b037ad14af22221c1ac7`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `feat(ingestion): –†–µ–∞–ª–∏–∑–∞—Ü–∏—è High-Throughput Data Ingestion —Å–∏—Å—Ç–µ–º—ã`  
üìÖ **–î–∞—Ç–∞:** 2025-12-27 19:40:49 +1000  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 5 —Ñ–∞–π–ª–æ–≤, +665 —Å—Ç—Ä–æ–∫

##### High-Throughput Architecture

```mermaid
flowchart LR
    subgraph Input
        API[FastAPI/Bot]
    end
    
    subgraph Redis
        Stream["Redis Stream<br/>driver:locations<br/>MAXLEN ~100k"]
    end
    
    subgraph Workers
        W1[Ingest Worker 1]
        W2[Ingest Worker 2]
        W3[Ingest Worker N]
    end
    
    subgraph PostgreSQL
        Table["driver_location_history<br/>(Partitioned)"]
        P1[y2025_w52]
        P2[y2026_w01]
        P3[y2026_w02]
    end
    
    API -->|XADD| Stream
    Stream -->|XREADGROUP| W1 & W2 & W3
    W1 & W2 & W3 -->|COPY| Table
    Table --> P1 & P2 & P3
```

##### Performance Comparison

| –ú–µ—Ç–æ–¥ | –ó–∞–ø–∏—Å–µ–π/—Å–µ–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|-------------|----------|
| INSERT (row-by-row) | ~1,000 | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π INSERT |
| INSERT (batch) | ~5,000 | –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π INSERT |
| **COPY (text)** | **~30,000** | PostgreSQL COPY |
| **COPY (binary)** | **~50,000** | Binary COPY —Å EWKT |

##### Ingest Worker Implementation

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `src/workers/ingest_worker.py`:**

```python
"""
High-Throughput Location Ingest Worker

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- Consumer Groups –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (XREADGROUP)
- Binary COPY –¥–ª—è ~10-50x —É—Å–∫–æ—Ä–µ–Ω–∏—è INSERT
- Poison Pill Handling: –∏–∑–æ–ª—è—Ü–∏—è "–±–∏—Ç—ã—Ö" –∑–∞–ø–∏—Å–µ–π
- XAUTOCLAIM –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- At-least-once delivery: XACK —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ COMMIT
"""

import asyncio
import os
import struct
from datetime import datetime, timezone
from io import BytesIO
from typing import List
from dataclasses import dataclass

import psycopg
from redis.asyncio import Redis

from src.config import settings
from src.core.logging import get_logger

logger = get_logger(__name__)

# Configuration
STREAM_NAME = "driver:locations"
CONSUMER_GROUP = "location_ingesters"
CONSUMER_NAME = f"worker_{os.getpid()}"
BATCH_SIZE = 2000
BATCH_TIMEOUT_MS = 5000
CLAIM_MIN_IDLE_MS = 60000
MAX_RETRIES = 3


@dataclass
class LocationRecord:
    """–ó–∞–ø–∏—Å—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏–∑ —Å—Ç—Ä–∏–º–∞."""
    entry_id: str
    driver_id: int
    latitude: float
    longitude: float
    timestamp: datetime
    retry_count: int = 0
    
    @classmethod
    def from_stream_entry(cls, entry_id: bytes, data: dict) -> "LocationRecord":
        entry_id_str = entry_id.decode() if isinstance(entry_id, bytes) else entry_id
        
        def get_value(key: str) -> str:
            if key.encode() in data:
                val = data[key.encode()]
                return val.decode() if isinstance(val, bytes) else val
            elif key in data:
                val = data[key]
                return val.decode() if isinstance(val, bytes) else val
            raise KeyError(f"Key {key} not found")
        
        return cls(
            entry_id=entry_id_str,
            driver_id=int(get_value("driver_id")),
            latitude=float(get_value("lat")),
            longitude=float(get_value("lon")),
            timestamp=datetime.fromisoformat(get_value("ts")),
        )


class IngestWorker:
    """High-throughput –≤–æ—Ä–∫–µ—Ä –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–π."""
    
    def __init__(self, redis: Redis, pg_dsn: str):
        self.redis = redis
        self.pg_dsn = pg_dsn.replace("+asyncpg", "")
        self._running = True
    
    async def setup(self):
        """–°–æ–∑–¥–∞—ë—Ç consumer group."""
        try:
            await self.redis.xgroup_create(
                STREAM_NAME, CONSUMER_GROUP, id="0", mkstream=True
            )
            logger.info("consumer_group_created", group=CONSUMER_GROUP)
        except Exception as e:
            if "BUSYGROUP" in str(e):
                logger.debug("consumer_group_exists")
            else:
                raise
    
    async def run(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –≤–æ—Ä–∫–µ—Ä–∞."""
        await self.setup()
        logger.info("ingest_worker_started", consumer=CONSUMER_NAME, batch_size=BATCH_SIZE)
        
        while self._running:
            try:
                await self._claim_abandoned_messages()
                await self._process_batch()
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.exception("ingest_worker_error", error=str(e))
                await asyncio.sleep(1)
    
    async def _claim_abandoned_messages(self):
        """XAUTOCLAIM: –∑–∞–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —É–ø–∞–≤—à–∏—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤."""
        try:
            result = await self.redis.xautoclaim(
                STREAM_NAME, CONSUMER_GROUP, CONSUMER_NAME,
                min_idle_time=CLAIM_MIN_IDLE_MS, start_id="0-0", count=BATCH_SIZE
            )
            
            if result and len(result) > 1 and result[1]:
                records = []
                for entry_id, data in result[1]:
                    try:
                        records.append(LocationRecord.from_stream_entry(entry_id, data))
                    except (KeyError, ValueError):
                        await self.redis.xack(STREAM_NAME, CONSUMER_GROUP, entry_id)
                
                if records:
                    logger.info("claimed_abandoned", count=len(records))
                    await self._ingest_batch(records)
        except Exception as e:
            logger.warning("xautoclaim_error", error=str(e))
    
    async def _process_batch(self):
        """–ß–∏—Ç–∞–µ—Ç –±–∞—Ç—á —á–µ—Ä–µ–∑ XREADGROUP."""
        result = await self.redis.xreadgroup(
            CONSUMER_GROUP, CONSUMER_NAME,
            streams={STREAM_NAME: ">"},
            count=BATCH_SIZE, block=BATCH_TIMEOUT_MS
        )
        
        if not result:
            return
        
        records = []
        for stream_name, entries in result:
            for entry_id, data in entries:
                try:
                    records.append(LocationRecord.from_stream_entry(entry_id, data))
                except (KeyError, ValueError):
                    await self.redis.xack(STREAM_NAME, CONSUMER_GROUP, entry_id)
        
        if records:
            await self._ingest_batch(records)
    
    async def _ingest_batch(self, records: List[LocationRecord]):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –±–∞—Ç—á —á–µ—Ä–µ–∑ COPY."""
        entry_ids = [r.entry_id for r in records]
        
        try:
            with psycopg.connect(self.pg_dsn) as conn:
                with conn.cursor() as cur:
                    with cur.copy(
                        "COPY driver_location_history (driver_id, location, recorded_at) "
                        "FROM STDIN"
                    ) as copy:
                        for r in records:
                            wkt = f"SRID=4326;POINT({r.longitude} {r.latitude})"
                            copy.write_row((r.driver_id, wkt, r.timestamp))
                conn.commit()
            
            await self.redis.xack(STREAM_NAME, CONSUMER_GROUP, *entry_ids)
            logger.info("batch_ingested", count=len(records))
            
        except Exception as e:
            logger.error("batch_copy_failed", error=str(e))
            await self._ingest_with_poison_detection(records)
    
    async def _ingest_with_poison_detection(self, records: List[LocationRecord]):
        """Row-by-row insert –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ poison pills."""
        with psycopg.connect(self.pg_dsn) as conn:
            for record in records:
                try:
                    with conn.cursor() as cur:
                        cur.execute(
                            """
                            INSERT INTO driver_location_history 
                                (driver_id, location, recorded_at)
                            VALUES 
                                (%s, ST_SetSRID(ST_MakePoint(%s, %s), 4326), %s)
                            """,
                            (record.driver_id, record.longitude, record.latitude, record.timestamp)
                        )
                    conn.commit()
                    await self.redis.xack(STREAM_NAME, CONSUMER_GROUP, record.entry_id)
                except Exception as e:
                    conn.rollback()
                    record.retry_count += 1
                    if record.retry_count >= MAX_RETRIES:
                        logger.error("poison_pill_detected", entry_id=record.entry_id)
                        await self.redis.xack(STREAM_NAME, CONSUMER_GROUP, record.entry_id)


async def main():
    redis = Redis.from_url(settings.REDIS_URL, decode_responses=False)
    worker = IngestWorker(redis, settings.DATABASE_URL)
    try:
        await worker.run()
    finally:
        await redis.close()


if __name__ == "__main__":
    asyncio.run(main())
```

##### Partitioning Migration

```python
# alembic/versions/003_partitioned_location_history.py

def upgrade():
    # –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
    op.execute("""
        CREATE TABLE driver_location_history (
            id UUID DEFAULT gen_random_uuid(),
            driver_id INTEGER NOT NULL REFERENCES drivers(id) ON DELETE CASCADE,
            location GEOMETRY(Point, 4326) NOT NULL,
            recorded_at TIMESTAMPTZ NOT NULL,
            PRIMARY KEY (id, recorded_at)
        ) PARTITION BY RANGE (recorded_at);
    """)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–¥–µ–ª—å–Ω—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
    from datetime import datetime, timedelta
    for week_offset in range(5):
        start = datetime.now() + timedelta(weeks=week_offset)
        week_num = start.isocalendar()[1]
        partition_name = f"y{start.year}_w{week_num:02d}"
        week_start = start - timedelta(days=start.weekday())
        week_end = week_start + timedelta(weeks=1)
        
        op.execute(f"""
            CREATE TABLE {partition_name} 
            PARTITION OF driver_location_history
            FOR VALUES FROM ('{week_start.date()}') TO ('{week_end.date()}');
        """)
    
    # DEFAULT –ø–∞—Ä—Ç–∏—Ü–∏—è –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
    op.execute("""
        CREATE TABLE driver_location_history_default 
        PARTITION OF driver_location_history DEFAULT;
    """)
```

---

### üìÖ –î–µ–Ω—å 3: 28 –¥–µ–∫–∞–±—Ä—è 2025

---

#### –ö–æ–º–º–∏—Ç—ã 8-9: `2c7a665`, `88965b2`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `feat: add driver CRUD endpoints and dependencies`  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** +140 —Å—Ç—Ä–æ–∫

##### Driver CRUD Endpoints

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| `POST` | `/api/v1/drivers` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è |
| `GET` | `/api/v1/drivers` | –°–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π |
| `GET` | `/api/v1/drivers/{id}` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–¥–∏—Ç–µ–ª–µ |
| `PATCH` | `/api/v1/drivers/{id}` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è |

---

#### –ö–æ–º–º–∏—Ç 10: `dec86f7`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `–ó–∞–ø–æ–ª–Ω–µ–Ω openspec/project.md`  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** +128 —Å—Ç—Ä–æ–∫

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º Tech Stack, Architecture Patterns, Domain Context.

---

#### –ö–æ–º–º–∏—Ç 11: `dbec0d59ea19cbfc775a7f60e8fc938e9d0f712e`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `feat: Production readiness - security hardening and Nginx integration`  
üìÖ **–î–∞—Ç–∞:** 2025-12-28 16:47:06 +1000  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 15 —Ñ–∞–π–ª–æ–≤, +611 —Å—Ç—Ä–æ–∫

##### Security Changes

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|-----------|------|-------|
| **CORS** | `allow_origins=["*"]` | –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã |
| **Rate Limiting** | –ù–µ—Ç | SlowAPI + Redis |
| **Nginx** | –ù–µ—Ç | SSL, Gzip, Security Headers |

##### Rate Limiting Implementation

```python
# src/main.py
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address

limiter = Limiter(
    key_func=get_remote_address,
    storage_uri=settings.REDIS_URL,
    default_limits=[settings.RATE_LIMIT_DEFAULT],  # 100/minute
    headers_enabled=True,
)

# GPS endpoint —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º –ª–∏–º–∏—Ç–æ–º
@app.post("/drivers/{id}/location")
@limiter.limit(settings.RATE_LIMIT_LOCATION)  # 30/minute
async def update_location(...):
    pass
```

##### Nginx Configuration

```nginx
# nginx/nginx.conf
server {
    listen 443 ssl http2;
    server_name myappnf.ru www.myappnf.ru;
    
    ssl_certificate /etc/letsencrypt/live/myappnf.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/myappnf.ru/privkey.pem;
    
    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000" always;
    
    # Gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;
    
    # API Proxy
    location /api/ {
        proxy_pass http://backend:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # WebSocket Proxy
    location /ws {
        proxy_pass http://backend:8000/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 3600s;
    }
    
    # Frontend
    location / {
        root /var/www/frontend;
        try_files $uri $uri/ /index.html;
    }
}
```

---

#### –ö–æ–º–º–∏—Ç 12: `7de9b09`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `fix: Enum values_callable for lowercase PostgreSQL compatibility`

–§–∏–∫—Å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ Enum —Å PostgreSQL (lowercase values).

---

### üìÖ –î–µ–Ω—å 4: 31 –¥–µ–∫–∞–±—Ä—è 2025

---

#### –ö–æ–º–º–∏—Ç 13: `38b44b0` (HEAD)

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `Initial commit: TMS project`  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 7 —Ñ–∞–π–ª–æ–≤, +151/-138 —Å—Ç—Ä–æ–∫

–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è Dashboard, —É–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.

---

---

### üìÖ –î–µ–Ω—å 5: 1 —è–Ω–≤–∞—Ä—è 2026

–§–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ OSRM, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –º–∞—à–∏–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ –∏ —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–∞ –±–∞–∑–µ JWT.

---

#### –ö–æ–º–º–∏—Ç—ã 1-3: `c20275f`, `5ca2a3b`, `54f0fd4`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `feat: RoutingService, OrderStateMachine and Data Layer Finalization`  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 16 —Ñ–∞–π–ª–æ–≤, +1280 —Å—Ç—Ä–æ–∫

##### Routing & Pricing (OSRM)

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω `RoutingService` –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å OSRM –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏.

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `src/services/routing.py`:**

```python
import re
from decimal import Decimal, ROUND_HALF_UP
from dataclasses import dataclass
from typing import Optional, Tuple
import httpx

from src.config import settings
from src.core.logging import get_logger

logger = get_logger(__name__)

@dataclass
class RouteResult:
    distance_meters: float      # –î–∏—Å—Ç–∞–Ω—Ü–∏—è –≤ –º–µ—Ç—Ä–∞—Ö
    duration_seconds: float     # –í—Ä–µ–º—è –≤ –ø—É—Ç–∏ (—Å–µ–∫—É–Ω–¥—ã)
    geometry: Optional[str] = None # Polyline –≥–µ–æ–º–µ—Ç—Ä–∏—è

class RoutingService:
    """–°–µ—Ä–≤–∏—Å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏."""
    
    def __init__(self, osrm_url: str = settings.OSRM_URL):
        self.osrm_url = osrm_url.rstrip("/")
    
    async def get_route(self, origin, destination) -> RouteResult:
        coords = f"{origin[0]},{origin[1]};{destination[0]},{destination[1]}"
        url = f"{self.osrm_url}/route/v1/driving/{coords}?overview=false"
        
        async with httpx.AsyncClient() as client:
            response = await client.get(url)
            data = response.json()
            
        best_route = data["routes"][0]
        return RouteResult(
            distance_meters=float(best_route["distance"]),
            duration_seconds=float(best_route["duration"])
        )
    
    def calculate_price(self, distance_meters: float) -> Decimal:
        dist_km = Decimal(str(distance_meters / 1000)).quantize(Decimal("0.01"))
        return (settings.PRICE_BASE + dist_km * settings.PRICE_PER_KM).quantize(Decimal("0.01"))
```

##### Order State Machine

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `python-statemachine` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –∑–∞–∫–∞–∑–∞.

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `src/services/order_workflow.py`:**

```python
from statemachine import StateMachine, State
from src.database.models import OrderStatus, DriverStatus

class OrderStateMachine(StateMachine):
    """–£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–æ–ª–µ–π –≤ –º–æ–¥–µ–ª–∏ Order."""
    pending = State("Pending", value=OrderStatus.PENDING, initial=True)
    assigned = State("Assigned", value=OrderStatus.ASSIGNED)
    driver_arrived = State("Driver Arrived", value=OrderStatus.DRIVER_ARRIVED)
    in_progress = State("In Progress", value=OrderStatus.IN_PROGRESS)
    completed = State("Completed", value=OrderStatus.COMPLETED, final=True)
    cancelled = State("Cancelled", value=OrderStatus.CANCELLED, final=True)

    assign = pending.to(assigned)
    arrive = assigned.to(driver_arrived)
    start_trip = driver_arrived.to(in_progress)
    complete = in_progress.to(completed)
    cancel = (pending | assigned | driver_arrived | in_progress).to(cancelled)

    def on_enter_assigned(self, driver_id: int):
        self.order.status = OrderStatus.ASSIGNED
        self.order.driver_id = driver_id

    def on_enter_completed(self):
        self.order.status = OrderStatus.COMPLETED
        self.order.end_time = datetime.utcnow()
        if self.order.driver:
            self.order.driver.status = DriverStatus.AVAILABLE
```

##### Data Layer: Exclusion Constraints & TSTZRANGE

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ `Order` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–∞–∫–ª–∞–¥–æ–∫.

```python
# src/database/models.py
class Order(Base):
    # –í—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
    time_range: Mapped[Optional[tuple]] = mapped_column(
        TSTZRANGE(),
        comment="[start, end) –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"
    )
    
    # –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    distance_meters: Mapped[Optional[float]] = mapped_column(nullable=True)
    price: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2), nullable=True)
    
    # Lifecycle timestamps
    arrived_at: Mapped[Optional[datetime]] = mapped_column(nullable=True)
    started_at: Mapped[Optional[datetime]] = mapped_column(nullable=True)

    __table_args__ = (
        # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è
        Index("ix_orders_time_range", "time_range", postgres_using="gist"),
    )
```

---

#### –ö–æ–º–º–∏—Ç 4: `931b495`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `feat(database): restore models and add routing fields`  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** +179/-400 —Å—Ç—Ä–æ–∫ (—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥)

–§–∏–Ω–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –º–æ–¥–µ–ª–µ–π –∏ —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–∫–∞–∑–æ–≤.

---

#### –ö–æ–º–º–∏—Ç 5: `97eeaa0`

üìù **–°–æ–æ–±—â–µ–Ω–∏–µ:** `feat: implement Telegram WebApp authentication and API protection`  
üìÖ **–î–∞—Ç–∞:** 2026-01-01 01:30:19 +1000  
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 9 —Ñ–∞–π–ª–æ–≤, +279 —Å—Ç—Ä–æ–∫

##### WebApp Authentication (HMAC-SHA256)

**–ü–æ–ª–Ω—ã–π –∫–æ–¥ `src/services/auth_service.py`:**

```python
import hmac, hashlib, jwt
from src.config import settings

class AuthService:
    def validate_init_data(self, init_data: str) -> dict:
        parsed_data = {k: v[0] for k, v in parse_qs(init_data).items()}
        received_hash = parsed_data.pop("hash")
        
        # –°–∫–ª–µ–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        data_check_string = "\n".join(f"{k}={v}" for k, v in sorted(parsed_data.items()))
        
        # HMAC-SHA256
        secret_key = hmac.new(b"WebAppData", settings.BOT_TOKEN.encode(), hashlib.sha256).digest()
        calculated_hash = hmac.new(secret_key, data_check_string.encode(), hashlib.sha256).hexdigest()
        
        if not hmac.compare_digest(calculated_hash, received_hash):
            raise ValueError("Hash verification failed")
            
        return json.loads(parsed_data["user"])

    def create_access_token(self, driver: Driver) -> str:
        payload = {"sub": str(driver.telegram_id), "driver_id": driver.id}
        return jwt.encode(payload, settings.JWT_KEY, algorithm="HS256")
```

##### API Protection

```python
# src/api/dependencies.py
async def get_current_driver(token: str = Depends(oauth2_scheme)) -> Driver:
    payload = jwt.decode(token, settings.JWT_KEY, algorithms=["HS256"])
    driver = await uow.drivers.get(payload["driver_id"])
    if not driver:
        raise HTTPException(401)
    return driver

# src/api/routes.py
@router.get("/orders")
async def get_my_orders(driver: Driver = Depends(get_current_driver)):
    # –†–æ—É—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –≤–æ–¥–∏—Ç–µ–ª—è–º
    return await order_service.get_driver_orders(driver.id)
```

---

## API Reference

### Auth API

| Endpoint | Method | Request | Response | Status |
|----------|--------|---------|----------|--------|
| `/api/v1/auth/login` | POST | `TelegramAuthRequest` | `TokenResponse` | 200 |

### Orders API

| Endpoint | Method | Request | Response | Status Codes |
|----------|--------|---------|----------|--------------|
| `/api/v1/orders` | POST | `OrderCreate` | `OrderResponse` | 201, 401, 409 |
| `/api/v1/orders/{id}/move` | PATCH | `OrderMoveRequest` | `OrderResponse` | 200, 401, 409 |
| `/api/v1/orders/{id}/arrive` | POST | ‚Äî | `OrderResponse` | 200, 401 |

### Drivers API

| Endpoint | Method | Request | Response | Status Codes |
|----------|--------|---------|----------|--------------|
| `/api/v1/drivers/me` | GET | ‚Äî | `DriverResponse` | 200, 401 |
| `/api/v1/drivers/live` | GET | ‚Äî | `DriverLocation[]` | 200, 401 |
| `/api/v1/drivers/location` | POST | `LocationUpdate` | ‚Äî | 204, 401 |

---

### üöÄ –≠—Ç–∞–ø: DevOps, –ê—É–¥–∏—Ç –∏ –ó–∞–ø—É—Å–∫ (Post-Day 5)

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±—ã–ª –ø—Ä–æ–≤–µ–¥—ë–Ω –ø—Ä–µ-–¥–µ–ø–ª–æ–π –∞—É–¥–∏—Ç (Pre-flight Check) –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏.

---

#### –ü—Ä–µ-–¥–µ–ø–ª–æ–π –∞—É–¥–∏—Ç (Risk Assessment)

–ë—ã–ª –ø—Ä–æ–≤–µ–¥—ë–Ω –∞–Ω–∞–ª–∏–∑ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ `185.207.1.122`, –≤—ã—è–≤–∏–≤—à–∏–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏:
1. **OSRM Data**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–æ–≤ –¥–æ—Ä–æ–≥ –≤ `osrm-data/`.
2. **WebSocket URL**: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π `localhost` –≤ –ø—Ä–æ–¥–∞–∫—à–Ω-—Å–±–æ—Ä–∫–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞.
3. **SSL/HTTPS**: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ Let's Encrypt –¥–ª—è –¥–æ–º–µ–Ω–∞ `myappnf.ru`.

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –î–µ–ø–ª–æ–π

1. **Frontend**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `frontend/.env`, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `VITE_WS_URL=wss://myappnf.ru/ws`. –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
2. **OSRM Automation**: –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `init_osrm.sh` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (wget) –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (extract, partition, customize) –∫–∞—Ä—Ç –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–æ–≥–æ –§–û.
3. **Telegram Bot**: –ü–æ–¥–∫–ª—é—á–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –±–æ–µ–≤–æ–π –±–æ—Ç **@Premium_Park_Robot**.
4. **–û—Ö–≤–∞—Ç —Ä–µ–≥–∏–æ–Ω–æ–≤**: –í OSRM –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –ü—Ä–∏–º–æ—Ä—Å–∫–æ–≥–æ –∫—Ä–∞—è –∏ –Ø–∫—É—Ç–∏–∏ (`far-eastern-fed-district`).

---

## API Reference

### Auth API

| Endpoint | Method | Request | Response | Status |
|----------|--------|---------|----------|--------|
| `/api/v1/auth/login` | POST | `TelegramAuthRequest` | `TokenResponse` | 200 |

### Orders API

| Endpoint | Method | Request | Response | Status Codes |
|----------|--------|---------|----------|--------------|
| `/api/v1/orders` | POST | `OrderCreate` | `OrderResponse` | 201, 401, 409 |
| `/api/v1/orders/{id}/move` | PATCH | `OrderMoveRequest` | `OrderResponse` | 200, 401, 409 |
| `/api/v1/orders/{id}/arrive` | POST | ‚Äî | `OrderResponse` | 200, 401 |

### Drivers API

| Endpoint | Method | Request | Response | Status Codes |
|----------|--------|---------|----------|--------------|
| `/api/v1/drivers/me` | GET | ‚Äî | `DriverResponse` | 200, 401 |
| `/api/v1/drivers/live` | GET | ‚Äî | `DriverLocation[]` | 200, 401 |
| `/api/v1/drivers/location` | POST | `LocationUpdate` | ‚Äî | 204, 401 |

---

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
### üöÄ –≠—Ç–∞–ø: –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–∫–æ–≤ –∏ –†–µ–∞–ª—å–Ω–∞—è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (Post-Day 5)
- **Backend**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å **Photon Geocoding** –∏ **OSRM Geometry**.
- **Frontend**: –í–Ω–µ–¥—Ä–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π (polyline) –Ω–∞ –∫–∞—Ä—Ç–µ.
- **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**: –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã fallback-–º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞.

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–∞ 1 —è–Ω–≤–∞—Ä—è 14:00+10):
- **–ö–æ–º–º–∏—Ç–æ–≤**: 21 (+3 –∑–∞ —Å–µ–≥–æ–¥–Ω—è)
- **–î–Ω–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: 6
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ (Python/TS)**: ~7500+
- **–°–µ—Ä–≤–∏—Å–æ–≤**: 11 (–≤–∫–ª—é—á–∞—è Geocoding, Routing, Auth)

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–ü—Ä–æ–µ–∫—Ç TMS –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥–µ–Ω —Å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–∞–≥–ª—É—à–µ–∫ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ —Å–ø–æ—Å–æ–±–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –ª—é–±–æ–º —Ä–µ–≥–∏–æ–Ω–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤, —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ —Ä–µ–∞–ª—å–Ω—ã–º –¥–æ—Ä–æ–≥–∞–º –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –º–∞—Ä—à—Ä—É—Ç–æ–≤.

**–ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**
1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: JWT + Telegram HMAC-SHA256 –≤–∞–ª–∏–¥–∞—Ü–∏—è.
2. **–ì–µ–æ—Å–µ—Ä–≤–∏—Å—ã**: –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã OSRM –∏ Photon, –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –ª–∏–º–∏—Ç–æ–≤.
3. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ State Machine –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∏ PostgreSQL Constraints –¥–ª—è –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö.

**–ü—Ä–æ–¥–∞–∫—à–µ–Ω:** [https://myappnf.ru](https://myappnf.ru)  
**–ë–æ—Ç:** [@Premium_Park_Robot](https://t.me/Premium_Park_Robot)

