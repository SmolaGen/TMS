# Развертывание (Deployment)

Проект настроен для развертывания с использованием **Docker Compose**, что обеспечивает изоляцию и воспроизводимость среды.

## Структура контейнеров

В `docker-compose.yml` описаны следующие сервисы:

1. **backend**: Основное API (FastAPI).
2. **ingest-worker**: Воркер для сохранения гео-данных.
3. **postgis**: PostgreSQL с расширением PostGIS.
4. **redis**: Брокер сообщений и кэш.
5. **osrm**: Сервер маршрутизации.
6. **photon**: Сервер геокодинга.
7. **nginx** (опционально/рекомендуется): Обратный прокси для терминации SSL и раздачи статики фронтенда.

## Подготовка к деплою

1. **Сервер**: Ubuntu LTS 22.04+ (рекомендуется), минимум 4GB RAM (из-за Java/ES в Photon и OSRM графов).
2. **Данные**:
   - Скачайте `*.osm.pbf` файл региона.
   - Подготовьте данные для OSRM (см. документацию OSRM).
3. **Конфигурация**:
   - Скопируйте `.env.example` в `.env` на сервере.
   - Задайте надежные пароли для БД (`POSTGRES_PASSWORD`).
   - Сгенерируйте `SECRET_KEY`.
   - Укажите домен `APP_DOMAIN` и настройки Telegram бота.

## Процесс запуска

1. Сборка и запуск фоном:
   ```bash
   docker-compose up -d --build
   ```

2. Проверка статуса:
   ```bash
   docker-compose ps
   ```
   Убедитесь, что все контейнеры в статусе `Up (healthy)`.

3. Логи:
   ```bash
   docker-compose logs -f backend
   ```

## CI/CD Рекомендации

Для автоматизации деплоя рекомендуется настроить (например, GitHub Actions):
1. **Build**: Сборка Docker образов при пуше в `main`.
2. **Test**: Запуск unit-тестов.
3. **Deploy**:
   - SSH подключение к серверу.
   - `git pull`
   - `docker-compose pull` (если используете Registry) или build на месте.
   - `docker-compose up -d`

## Бэкапы

Настройте регулярный бэкап базы данных:
```bash
# Пример команды для cron
docker exec -t tms-postgis pg_dumpall -c -U tms > dump_$(date +%Y-%m-%d).sql
```
