<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMS WebApp Debug</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #000;
            color: #0f0;
        }
        .section {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #0f0;
        }
        h3 {
            color: #ff0;
        }
        .error {
            color: #f00;
        }
        .success {
            color: #0f0;
        }
    </style>
</head>
<body>
    <h1>TMS WebApp Diagnostics</h1>
    
    <div class="section">
        <h3>1. Telegram WebApp Status</h3>
        <div id="tg-status"></div>
    </div>

    <div class="section">
        <h3>2. Init Data</h3>
        <div id="init-data"></div>
    </div>

    <div class="section">
        <h3>3. User Info</h3>
        <div id="user-info"></div>
    </div>

    <div class="section">
        <h3>4. Backend Connection</h3>
        <div id="backend-status"></div>
    </div>

    <div class="section">
        <h3>5. Auth Test</h3>
        <button onclick="testAuth()">Test Authentication</button>
        <div id="auth-result"></div>
    </div>

    <script>
        const log = (elementId, message, isError = false) => {
            const el = document.getElementById(elementId);
            const className = isError ? 'error' : 'success';
            el.innerHTML += `<div class="${className}">${message}</div>`;
        };

        // 1. Check Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            log('tg-status', '✓ Telegram WebApp SDK loaded');
            tg.ready();
            log('tg-status', '✓ ready() called');
            tg.expand();
            log('tg-status', '✓ expand() called');
            log('tg-status', `Version: ${tg.version}`);
            log('tg-status', `Platform: ${tg.platform}`);
            log('tg-status', `Color Scheme: ${tg.colorScheme}`);
        } else {
            log('tg-status', '✗ Telegram WebApp SDK not found', true);
        }

        // 2. Init Data
        if (tg?.initData) {
            log('init-data', '✓ initData available');
            log('init-data', `Length: ${tg.initData.length} chars`);
            log('init-data', `First 100 chars: ${tg.initData.substring(0, 100)}...`);
        } else {
            log('init-data', '✗ No initData (not opened from Telegram?)', true);
        }

        // 3. User Info
        if (tg?.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            log('user-info', `✓ User ID: ${user.id}`);
            log('user-info', `✓ Name: ${user.first_name} ${user.last_name || ''}`);
            log('user-info', `✓ Username: @${user.username || 'N/A'}`);
            log('user-info', `✓ Language: ${user.language_code || 'N/A'}`);
        } else {
            log('user-info', '✗ No user data', true);
        }

        // 4. Backend Connection
        fetch('https://myappnf.ru/health')
            .then(r => r.json())
            .then(data => {
                log('backend-status', '✓ Backend is healthy');
                log('backend-status', JSON.stringify(data, null, 2));
            })
            .catch(err => {
                log('backend-status', `✗ Backend connection failed: ${err.message}`, true);
            });

        // 5. Auth Test
        async function testAuth() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = '<div>Testing authentication...</div>';
            
            if (!tg?.initData) {
                log('auth-result', '✗ Cannot test: no initData', true);
                return;
            }

            try {
                const response = await fetch('https://myappnf.ru/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        init_data: tg.initData
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    log('auth-result', '✓ Authentication successful!');
                    log('auth-result', `Token type: ${data.token_type}`);
                    log('auth-result', `Role: ${data.role}`);
                    log('auth-result', `Token (first 50 chars): ${data.access_token.substring(0, 50)}...`);
                } else {
                    log('auth-result', `✗ Auth failed: ${data.detail || JSON.stringify(data)}`, true);
                }
            } catch (err) {
                log('auth-result', `✗ Request failed: ${err.message}`, true);
            }
        }

        // Auto-expand log on errors
        window.onerror = (msg, url, line, col, error) => {
            document.body.innerHTML += `
                <div class="section error">
                    <h3>JavaScript Error!</h3>
                    <div>Message: ${msg}</div>
                    <div>File: ${url}:${line}:${col}</div>
                    <div>Error: ${error}</div>
                </div>
            `;
        };
    </script>
</body>
</html>
