---
trigger: always_on
---

# TMS Project Rules & Standards for Google Antigravity

## 1. Архитектурный стандарт (Clean Architecture)
*   **Слои системы**: Строго разделяй код на **Presentation** (FastAPI роуты, WebSocket, бот), **Application** (бизнес-сервисы, менеджеры локаций), **Domain** (модели SQLAlchemy, Pydantic схемы) и **Infrastructure** (репозитории, Unit of Work, подключения) [3].
*   **Доступ к данным**: Все операции с БД должны выполняться через паттерны **Repository** и **Unit of Work (UoW)** [4], [5]. Прямое использование асинхронных сессий SQLAlchemy в слое Presentation запрещено [4].
*   **Типизация**: Обязательно используй **SQLAlchemy 2.x** в декларативном стиле и строгую типизацию **Pydantic v2** для всех API-схем [6], [7].

## 2. Работа с GPS и High-Throughput Ingestion
*   **Redis Streams**: Для приема GPS-координат (до 50,000 в сек) всегда используй **Redis Streams** с параметром `MAXLEN ~100k` [8], [9].
*   **PostgreSQL COPY**: При сохранении истории перемещений в таблицу `driver_location_history` используй механизм **Binary COPY** через библиотеку `psycopg`, а не стандартные `INSERT`, чтобы обеспечить максимальную пропускную способность [10], [11].
*   **Геоданные**: Все пространственные данные храни в формате **WGS84 (SRID 4326)** с использованием расширения **PostGIS** [12], [7].
*   **Партиционирование**: Таблица истории локаций должна быть **партиционирована по времени (недельные партиции)** для оптимизации запросов [9], [13].

## 3. Бизнес-логика и безопасность
*   **State Machine**: Жизненный цикл заказа (от `Pending` до `Completed`) должен управляться исключительно через библиотеку `python-statemachine` [14], [15].
*   **Exclusion Constraints**: Для предотвращения пересечения заказов одного водителя по времени используй **GIST-индексы** и ограничения `EXCLUDE` на уровне PostgreSQL [16], [17].
*   **Валидация**: Авторизация Telegram WebApp должна проверяться через **HMAC-SHA256** с использованием токена бота [18], [19].
*   **Rate Limiting**: Все эндпоинты обновления локации должны быть защищены через **SlowAPI** (лимит: 30 запросов в минуту) [12], [20].

## 4. Требования к автономности и проверке (Antigravity Specific)
*   **Политика исполнения (Autonomy)**: Для разработки новых фич используй режим **Turbo** для автоматической установки зависимостей и запуска тестов, но добавь `rm`, `sudo` и `curl` в **Deny List** для безопасности [21], [22], [23].
*   **Генерация Артефактов**: После выполнения задачи агент ОБЯЗАН создать **Walkthrough** с результатами тестов и **Screenshots** (или запись видео через расширение Chrome) для подтверждения корректности работы фронтенда и карты [24], [25], [26].
*   **Интеграция MCP**: Используй **MCP-сервер GitHub** для анализа истории коммитов перед рефакторингом и **MCP PostgreSQL** для анализа текущих индексов и схем таблиц [27], [28].
*   **Обратная связь**: Все изменения в планах реализации должны вноситься через систему **Google Docs-style комментариев** внутри артефактов [29], [30].
