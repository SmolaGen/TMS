#TRUNCATE
# PRD: Анализ и стабилизация проекта

## Цели
- Провести полный аудит структуры проекта.
- Актуализировать системные промпты и конфигурацию в папке `.ralph`.
- Создать актуальную карту проекта (context).

## Задачи (PRD)
- [x] Провести анализ проекта: изучить все файлы в `src/`, определить зависимости и составить отчет в `PROJECT_ANALYSIS.md`.
- [x] Актуализировать `system_prompt.md` и `architect_prompt.md` на основе текущего стека (FastAPI, PostGIS, Telegram Bot).
- [x] Проверить и исправить импорты во всех файлах `src/`, чтобы избежать циклических зависимостей.
- [x] Сформировать новый детальный список задач для реализации бэкенда.

## Реализация авторизации через Telegram

### Цель
Полная реализация серверной логики для аутентификации пользователей через Telegram WebApp. Это включает в себя валидацию данных, полученных от Telegram, поиск или автоматическую регистрацию водителей в системе и выдачу JWT токенов для последующей авторизации в API.

### Задачи
- [x] **Шаг 1: Проверка и обновление модели Driver**
    - **Файл:** `src/database/models.py`
    - **Описание:** Убедиться, что модель `Driver` содержит необходимые поля для хранения информации о водителе, полученной из Telegram. Добавить `telegram_id` (BigInteger, unique, indexed), `name` (String), `username` (String, unique, nullable), `is_active` (Boolean, default True). Убедиться, что `UserRole` может быть присвоена новому водителю.
- [ ] **Шаг 2: Обновление схем TelegramAuthRequest и TokenResponse**
    - **Файл:** `src/schemas/auth.py`
    - **Описание:** Проверить/обновить схемы `TelegramAuthRequest` для приема данных от Telegram и `TokenResponse` для выдачи JWT токенов.
- [ ] **Шаг 3: Реализация методов в AuthService**
    - **Файл:** `src/services/auth_service.py`
    - **Описание:** Реализовать методы `validate_init_data` для проверки данных, полученных от Telegram, и `get_token_response` для генерации JWT токена после успешной аутентификации/регистрации.
- [ ] **Шаг 4: Реализация методов в DriverService**
    - **Файл:** `src/services/driver_service.py`
    - **Описание:** Реализовать методы `get_by_telegram_id` для поиска водителя по Telegram ID и `create_driver_from_telegram` для автоматической регистрации нового водителя на основе данных из Telegram.
- [ ] **Шаг 5: Добавление настройки в config.py**
    - **Файл:** `src/config.py`
    - **Описание:** Добавить настройку для времени жизни `initData` (например, `TELEGRAM_INIT_DATA_LIFETIME_SECONDS`).
- [ ] **Шаг 6: Создание юнит-тестов для AuthService**
    - **Файл:** `tests/test_auth_service.py`
    - **Описание:** Создать новый файл с юнит-тестами для `AuthService`, покрывающий логику валидации данных и генерации токенов.
- [ ] **Шаг 7: Добавление юнит-тестов для DriverService**
    - **Файл:** `tests/test_driver_service.py`
    - **Описание:** Добавить юнит-тесты для `DriverService`, покрывающие логику получения и создания водителей по Telegram ID.
- [ ] **Шаг 8: Создание интеграционных тестов для API**
    - **Файл:** `tests/test_api_auth.py`
    - **Описание:** Создать новый файл с интеграционными тестами для эндпоинта `/v1/auth/login`, проверяющий полный цикл авторизации через Telegram.
