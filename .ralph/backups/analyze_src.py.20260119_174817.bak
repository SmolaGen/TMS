import os
import re

def analyze_python_file(filepath):
    imports = []
    classes = []
    functions = []
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()
            # Find imports
            imports.extend(re.findall(r'^(?:from\s+[\w\.]+\s+import\s+[\w,\s]+|import\s+[\w\.]+)', content, re.MULTILINE))
            # Find classes
            classes.extend(re.findall(r'^class\s+(\w+)(?:\(.*\))?:', content, re.MULTILINE))
            # Find functions
            functions.extend(re.findall(r'^def\s+(\w+)\s*\(.*\):', content, re.MULTILINE))
    except Exception as e:
        return {"error": str(e)}
    return {
        "imports": imports,
        "classes": classes,
        "functions": functions
    }

def generate_project_analysis(src_dir="src"):
    analysis_report = []
    other_files = []

    analysis_report.append("# Project Analysis Report\n\n")
    analysis_report.append("## Overview\n")
    analysis_report.append(f"This report analyzes the structure and content of the `{src_dir}/` directory.\n\n")

    analysis_report.append("## Directory Structure\n")
    all_files = []
    for root, dirs, files in os.walk(src_dir):
        # Modify dirs in-place to skip __pycache__
        if '__pycache__' in dirs:
            dirs.remove('__pycache__')
        for file in files:
            all_files.append(os.path.join(root, file))
    
    all_files.sort() # Sort for consistent output
    for f in all_files:
        analysis_report.append(f"- `{f}`\n")
    analysis_report.append("\n")

    analysis_report.append("## Python Files Analysis\n")
    for root, dirs, files in os.walk(src_dir):
        if '__pycache__' in dirs:
            dirs.remove('__pycache__') # Ensure we don't traverse into __pycache__
        for file in files:
            if file.endswith(".py"):
                filepath = os.path.join(root, file)
                analysis_report.append(f"### `{filepath}`\n")
                data = analyze_python_file(filepath)
                if "error" in data:
                    analysis_report.append(f"Error analyzing file: {data['error']}\n\n")
                    continue
                
                analysis_report.append("#### Imports:\n")
                if data["imports"]:
                    for imp in data["imports"]:
                        analysis_report.append(f"- `{imp}`\n")
                else:
                    analysis_report.append("  No explicit imports found.\n")
                
                analysis_report.append("\n#### Classes:\n")
                if data["classes"]:
                    for cls in data["classes"]:
                        analysis_report.append(f"- `{cls}`\n")
                else:
                    analysis_report.append("  No classes found.\n")
                
                analysis_report.append("\n#### Functions:\n")
                if data["functions"]:
                    for func in data["functions"]:
                        analysis_report.append(f"- `{func}`\n")
                else:
                    analysis_report.append("  No functions found.\n")
                analysis_report.append("\n")
            else:
                other_files.append(os.path.join(root, file))

    analysis_report.append("## Other Files\n")
    if other_files:
        for f in sorted(other_files):
            analysis_report.append(f"- `{f}`\n")
    else:
        analysis_report.append("No non-Python files found in `src/`.\n")

    with open("PROJECT_ANALYSIS.md", "w", encoding="utf-8") as f:
        f.write("".join(analysis_report))

if __name__ == "__main__":
    generate_project_analysis()
